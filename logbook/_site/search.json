[
  {
    "objectID": "rings-example/rings_example/index.html",
    "href": "rings-example/rings_example/index.html",
    "title": "Example single indicator vs. multiple rings",
    "section": "",
    "text": "library(tidyverse, warn.conflicts = FALSE)\nlibrary(glue)\nlibrary(here)\nlibrary(binsreg)\nlibrary(kfbmisc)",
    "crumbs": [
      "Rings Example",
      "Example single indicator vs. multiple rings"
    ]
  },
  {
    "objectID": "rings-example/rings_example/index.html#counterfactual-trends-everywhere",
    "href": "rings-example/rings_example/index.html#counterfactual-trends-everywhere",
    "title": "Example single indicator vs. multiple rings",
    "section": "Counterfactual Trends Everywhere",
    "text": "Counterfactual Trends Everywhere\nFirst we will generate a setting where parallel trends is constant across distance from nearest treated (e.g. small neighborhood around treatment where treatment location is random). This makes rings very effective.\n\nset.seed(100)\ndf &lt;- tibble(id = 1:500) |&gt;\n  # Generate Treatment and Distance\n  mutate(\n    treat = runif(n()) &gt; 0.8,\n    treat = as.numeric(treat),\n    control = 1 - treat,\n    dist = runif(n(), 0, 90),\n    dist = dist * (1 - treat)\n  ) |&gt;\n  # Make pre-post\n  expand_grid(t = c(0, 1)) |&gt;\n  # Treatment Effects\n  mutate(\n    te = treat * t * 2,\n    spill1 = 1.5 * t * exp(-0.03 * dist) * (1 - treat) * (dist &lt;= 40),\n    eps = rnorm(n(), mean = 0, sd = 0.05),\n    y1 = 2 * t + te + spill1 + eps\n  )\n\n\nfirst_diff &lt;- df |&gt;\n  arrange(id, t) |&gt;\n  group_by(id) |&gt;\n  mutate(\n    d_y1 = y1 - lag(y1)\n  ) |&gt;\n  filter(t == 1)\n\nggplot() +\n  geom_point(\n    data = first_diff, aes(x = dist, y = d_y1), \n    shape = 16, col = \"lightgrey\"\n  ) +\n  labs(\n    x = \"Distance to nearest treated\", \n    y = \"Change in y\"\n  ) +\n  kfbmisc::theme_kyle(base_size = 12)\n\n\n\n\n\n\n\n\n\nAd-Hoc Approach\n\n# Bins for 0-15, 15-30, 30-45\nfirst_diff &lt;- first_diff |&gt;\n  mutate(\n    within_0_60  = dist &gt; 0 & dist &lt;= 60,\n    within_0_15  = dist &gt; 0 & dist &lt;= 15,\n    within_15_30 = dist &gt; 15 & dist &lt;= 30,\n    within_30_45 = dist &gt; 30 & dist &lt;= 45,\n    within_45_60 = dist &gt; 45 & dist &lt;= 60\n  )\n\nreg &lt;- fixest::feols(\n  d_y1 ~ treat + within_0_15 + within_15_30 + within_30_45 + within_45_60,\n  data = first_diff\n) |&gt; coef()\n\ndots &lt;- tribble(\n  ~x, ~fit,\n  0, reg[[\"treat\"]] + reg[[\"(Intercept)\"]],\n  7.5, reg[[\"within_0_15TRUE\"]] + reg[[\"(Intercept)\"]],\n  22.5, reg[[\"within_15_30TRUE\"]] + reg[[\"(Intercept)\"]],\n  37.5, reg[[\"within_30_45TRUE\"]] + reg[[\"(Intercept)\"]],\n  52.5, reg[[\"within_45_60TRUE\"]] + reg[[\"(Intercept)\"]],\n)\n\nline &lt;- tribble(\n  ~x, ~fit,\n  0, reg[[\"within_0_15TRUE\"]] + reg[[\"(Intercept)\"]],\n  15, reg[[\"within_0_15TRUE\"]] + reg[[\"(Intercept)\"]],\n  15, NA,\n  15, reg[[\"within_15_30TRUE\"]] + reg[[\"(Intercept)\"]],\n  30, reg[[\"within_15_30TRUE\"]] + reg[[\"(Intercept)\"]],\n  30, NA,\n  30, reg[[\"within_30_45TRUE\"]] + reg[[\"(Intercept)\"]],\n  45, reg[[\"within_30_45TRUE\"]] + reg[[\"(Intercept)\"]],\n  45, NA,\n  45, reg[[\"within_45_60TRUE\"]] + reg[[\"(Intercept)\"]],\n  60, reg[[\"within_45_60TRUE\"]] + reg[[\"(Intercept)\"]]\n)\n\nreg_within &lt;- fixest::feols(\n  d_y1 ~ treat + within_0_60,\n  data = first_diff\n) |&gt; coef()\n\ndots_within &lt;- tribble(\n  ~x, ~fit,\n  0, reg_within[[\"treat\"]] + reg_within[[\"(Intercept)\"]],\n  30, reg_within[[\"within_0_60TRUE\"]] + reg_within[[\"(Intercept)\"]]\n)\n\nline_within &lt;- tribble(\n  ~x, ~fit,\n  0, reg_within[[\"within_0_60TRUE\"]] + reg_within[[\"(Intercept)\"]],\n  60, reg_within[[\"within_0_60TRUE\"]] + reg_within[[\"(Intercept)\"]],\n  60, NA,\n)\n\n\n(plot_rings &lt;- ggplot() +\n  geom_point(data = first_diff, aes(x = dist, y = d_y1), shape = 16, col = \"lightgrey\") +\n  geom_hline(yintercept = reg[[(\"(Intercept)\")]], linetype = \"longdash\") +\n  geom_point(data = dots, aes(x = x, y = fit), col = \"#5e81ac\", size = 3, shape = 19) +\n  geom_line(data = line, aes(x = x, y = fit), col = \"#5e81ac\", linewidth = 1.5) +\n  theme_kyle(base_size = 12) +\n  labs(\n    x = \"Distance from Nearest Treated\", \n    y = \"Change in Outcome ($\\\\Delta Y$)\"\n  ) +\n  scale_x_continuous(breaks = c(0, 15, 30, 45, 60, 75, 90), labels = c(\"Treated\", 15, 30, 45, 60, 75, 90)) +\n  scale_y_continuous(limits = c(1, 4.25)) +\n  # Annotation: Counterfactual Trend\n  geom_text(\n    data = data.frame(x = 1, y = 1.78, label = \"Counterfactual Trend Estimate\"),\n    mapping = aes(x = x, y = y, label = label), size = 4,\n    hjust = 0L, vjust = 0L, fontface = 3, inherit.aes = FALSE\n  ))\n\n\n\n\n\n\n\n\n\n(plot_within &lt;- ggplot() +\n  geom_point(data = first_diff, aes(x = dist, y = d_y1), shape = 16, col = \"lightgrey\") +\n  geom_hline(yintercept = reg_within[[(\"(Intercept)\")]], linetype = \"longdash\") +\n  geom_point(data = dots_within, aes(x = x, y = fit), col = \"#bf616a\", size = 3, shape = 19) +\n  geom_line(data = line_within, aes(x = x, y = fit), col = \"#bf616a\", linewidth = 1.5) +\n  theme_kyle(base_size = 12) +\n  labs(\n    x = \"Distance from Nearest Treated\", \n    y = \"Change in Outcome ($\\\\Delta Y$)\"\n  ) +\n  scale_x_continuous(breaks = c(0, 15, 30, 45, 60, 75, 90), labels = c(\"Treated\", 15, 30, 45, 60, 75, 90)) +\n  scale_y_continuous(limits = c(1, 4.25)) +\n  # Annotation: Counterfactual Trend\n  geom_text(\n    data = data.frame(x = 1, y = 1.78, label = \"Counterfactual Trend Estimate\"),\n    mapping = aes(x = x, y = y, label = label), size = 4,\n    hjust = 0L, vjust = 0L, fontface = 3, inherit.aes = FALSE\n  ))\n\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_line()`).\n\n\n\n\n\n\n\n\n\n\nkfbmisc::tikzsave(\n  here(\"figures/rings-example/rings_pt_everywhere.pdf\"),\n  plot_rings, width = 8, height = 8 * 9 / 16\n)\nkfbmisc::tikzsave(\n  here(\"figures/rings-example/within_pt_everywhere.pdf\"),\n  plot_within, width = 8, height = 8 * 9 / 16\n)\n\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_line()`).\n\n\n\n(plot_both &lt;- ggplot() +\n  geom_point(\n    data = first_diff |&gt; filter(dist &lt;= 90),\n    aes(x = dist, y = d_y1), shape = 16, col = \"lightgrey\"\n  ) +\n  geom_hline(yintercept = reg[[(\"(Intercept)\")]], linetype = \"dotted\") +\n  # Within\n  geom_point(data = dots_within, aes(x = x, y = fit, color = \"#bf616a\"), size = 3, shape = 19) +\n  geom_line(data = line_within, aes(x = x, y = fit, color = \"#bf616a\", linetype = 1), linewidth = 1.5) +\n  # Rings\n  geom_point(data = dots, aes(x = x, y = fit, color = \"#5e81ac\"), size = 3, shape = 19) +\n  geom_line(data = line, aes(x = x, y = fit, color = \"#5e81ac\", linetype = 1), linewidth = 1.5) +\n  theme_kyle(base_size = 12) +\n  labs(\n    x = \"Distance from Nearest Treated\", y = \"Change in Outcome ($\\\\Delta Y$)\",\n    color = \"Estimation Method\"\n  ) +\n  scale_x_continuous(\n    breaks = c(0, 15, 30, 45, 60, 75, 90),\n    labels = c(\"Treated\", 15, 30, 45, 60, 75, 90)\n  ) +\n  scale_y_continuous(limits = c(1, 4.25)) +\n  scale_color_identity(\n    breaks = c(\"#bf616a\", \"#5e81ac\"),\n    labels = c(\"One Ring\", \"Multiple Rings\"),\n    guide = guide_legend(\n      override.aes = list(linetype = c(1, 1), shape = c(NA, NA), size = c(2, 2))\n    )\n  ) +\n  scale_linetype_identity(guide = \"none\") +\n  theme(\n    panel.grid.minor = element_blank(),\n    legend.position = c(0.8, 0.8),\n    legend.background = element_rect(fill = \"white\")\n    # legend.key.width = unit(4,\"cm\")\n  ) +\n  # Annotation: Counterfactual Trend\n  geom_text(\n    data = data.frame(x = 1, y = 1.78, label = \"Counterfactual Trend Estimate\"),\n    mapping = aes(x = x, y = y, label = label), size = 4,\n    hjust = 0L, vjust = 0L, fontface = 3, inherit.aes = FALSE\n  ))\n\nWarning: A numeric `legend.position` argument in `theme()` was deprecated in ggplot2\n3.5.0.\nℹ Please use the `legend.position.inside` argument of `theme()` instead.\n\n\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_line()`).\n\n\n\n\n\n\n\n\n\n\nkfbmisc::tikzsave(\n  here::here(\"figures/rings-example/rings_v_within_pt_everywhere.pdf\"), \n  plot_both, width = 8, height = 8 * 9 / 16\n)\n\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_line()`).",
    "crumbs": [
      "Rings Example",
      "Example single indicator vs. multiple rings"
    ]
  },
  {
    "objectID": "rings-example/rings_example/index.html#average-counterfactual-trends-only",
    "href": "rings-example/rings_example/index.html#average-counterfactual-trends-only",
    "title": "Example single indicator vs. multiple rings",
    "section": "Average Counterfactual Trends Only",
    "text": "Average Counterfactual Trends Only\nNo we will generate a setting where parallel trends holds on average for the treated and the control units (for a given \\(\\bar{d}\\)), but does not hold at every distance. In this setting, rings can not be trusted since they are based on the outer-most rings’ counterfactual trend.\n\nset.seed(100)\n\ndf &lt;- tibble(id = 1:500) |&gt;\n  # Generate Treatment and Distance\n  mutate(\n    treat = runif(n()) &gt; 0.8,\n    treat = as.numeric(treat),\n    control = 1 - treat,\n    dist = runif(n(), 0, 90),\n    dist = dist * (1 - treat)\n  ) |&gt;\n  # Make pre-post\n  expand_grid(t = c(0, 1)) |&gt;\n  # Treatment Effects\n  mutate(\n    te = treat * t * 2,\n    trend = 0.6 * sin(pi / 20 * dist),\n    spill1 = 1.5 * t * exp(-0.03 * dist) * (1 - treat) * (dist &lt;= 40),\n    eps = rnorm(n(), mean = 0, sd = 0.05),\n    y0 = trend * t + eps,\n    y1 = trend * t + 2 * t + te + spill1 + eps\n  )\n\n# Take First Differences\nfirst_diff &lt;- df |&gt;\n  arrange(id, t) |&gt;\n  group_by(id) |&gt;\n  mutate(\n    d_y1 = y1 - lag(y1),\n    d_y0 = y0 - lag(y0)\n  ) |&gt;\n  filter(t == 1)\n\nggplot() +\n  geom_point(data = first_diff, aes(x = dist, y = d_y1), shape = 16, col = \"lightgrey\")\n\n\n\n\n\n\n\n\n\nAd-Hoc Approach\n\n# Bins for 0-15, 15-30, 30-45\nfirst_diff &lt;- first_diff |&gt;\n  mutate(\n    within_0_60  = dist &gt; 0 & dist &lt;= 60,\n    within_0_15  = dist &gt; 0 & dist &lt;= 15,\n    within_15_30 = dist &gt; 15 & dist &lt;= 30,\n    within_30_45 = dist &gt; 30 & dist &lt;= 45,\n    within_45_60 = dist &gt; 45 & dist &lt;= 60\n  )\n\nreg &lt;- fixest::feols(\n  d_y1 ~ treat + within_0_15 + within_15_30 + within_30_45 + within_45_60, \n  data = first_diff\n) |&gt; coef()\n\ndots &lt;- tribble(\n  ~x, ~fit,\n  0, reg[[\"treat\"]] + reg[[\"(Intercept)\"]],\n  7.5, reg[[\"within_0_15TRUE\"]] + reg[[\"(Intercept)\"]],\n  22.5, reg[[\"within_15_30TRUE\"]] + reg[[\"(Intercept)\"]],\n  37.5, reg[[\"within_30_45TRUE\"]] + reg[[\"(Intercept)\"]],\n  52.5, reg[[\"within_45_60TRUE\"]] + reg[[\"(Intercept)\"]],\n)\n\nline &lt;- tribble(\n  ~x, ~fit,\n  0, reg[[\"within_0_15TRUE\"]] + reg[[\"(Intercept)\"]],\n  15, reg[[\"within_0_15TRUE\"]] + reg[[\"(Intercept)\"]],\n  15, NA,\n  15, reg[[\"within_15_30TRUE\"]] + reg[[\"(Intercept)\"]],\n  30, reg[[\"within_15_30TRUE\"]] + reg[[\"(Intercept)\"]],\n  30, NA,\n  30, reg[[\"within_30_45TRUE\"]] + reg[[\"(Intercept)\"]],\n  45, reg[[\"within_30_45TRUE\"]] + reg[[\"(Intercept)\"]],\n  45, NA,\n  45, reg[[\"within_45_60TRUE\"]] + reg[[\"(Intercept)\"]],\n  60, reg[[\"within_45_60TRUE\"]] + reg[[\"(Intercept)\"]]\n)\n\nreg_within &lt;- fixest::feols(d_y1 ~ treat + within_0_60, data = first_diff) |&gt; coef()\n\ndots_within &lt;- tribble(\n  ~x, ~fit,\n  0, reg_within[[\"treat\"]] + reg_within[[\"(Intercept)\"]],\n  30, reg_within[[\"within_0_60TRUE\"]] + reg_within[[\"(Intercept)\"]]\n)\n\nline_within &lt;- tribble(\n  ~x, ~fit,\n  0, reg_within[[\"within_0_60TRUE\"]] + reg_within[[\"(Intercept)\"]],\n  60, reg_within[[\"within_0_60TRUE\"]] + reg_within[[\"(Intercept)\"]],\n  60, NA,\n)\n\n\n(plot_rings &lt;- ggplot() +\n  geom_point(data = first_diff, aes(x = dist, y = d_y1), shape = 16, col = \"lightgrey\") +\n  geom_hline(yintercept = reg[[(\"(Intercept)\")]], linetype = \"longdash\") +\n  geom_point(data = dots, aes(x = x, y = fit), col = \"#5e81ac\", size = 3, shape = 19) +\n  geom_line(data = line, aes(x = x, y = fit), col = \"#5e81ac\", linewidth = 1.5) +\n  theme_kyle(base_size = 12) +\n  labs(x = \"Distance from Nearest Treated\", y = \"Change in Outcome ($\\\\Delta Y$)\") +\n  scale_x_continuous(breaks = c(0, 15, 30, 45, 60, 75, 90), labels = c(\"Treated\", 15, 30, 45, 60, 75, 90)) +\n  scale_y_continuous(limits = c(1, 4.25)) +\n  # Annotation: Counterfactual Trend\n  geom_text(\n    data = data.frame(x = 1, y = 1.78, label = \"Counterfactual Trend Estimate\"),\n    mapping = aes(x = x, y = y, label = label), size = 4,\n    hjust = 0L, vjust = 0L, fontface = 3, inherit.aes = FALSE\n  ))\n\n\n\n\n\n\n\n\n\n(plot_within &lt;- ggplot() +\n  geom_point(data = first_diff, aes(x = dist, y = d_y1), shape = 16, col = \"lightgrey\") +\n  geom_hline(yintercept = reg_within[[(\"(Intercept)\")]], linetype = \"longdash\") +\n  geom_point(data = dots_within, aes(x = x, y = fit), col = \"#bf616a\", size = 3, shape = 19) +\n  geom_line(data = line_within, aes(x = x, y = fit), col = \"#bf616a\", linewidth = 1.5) +\n  theme_kyle(base_size = 12) +\n  labs(x = \"Distance from Nearest Treated\", y = \"Change in Outcome ($\\\\Delta Y$)\") +\n  scale_x_continuous(breaks = c(0, 15, 30, 45, 60, 75, 90), labels = c(\"Treated\", 15, 30, 45, 60, 75, 90)) +\n  scale_y_continuous(limits = c(1, 4.25)) +\n  # Annotation: Counterfactual Trend\n  geom_text(\n    data = data.frame(x = 1, y = 1.78, label = \"Counterfactual Trend Estimate\"),\n    mapping = aes(x = x, y = y, label = label), size = 4,\n    hjust = 0L, vjust = 0L, fontface = 3, inherit.aes = FALSE\n  ))\n\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_line()`).\n\n\n\n\n\n\n\n\n\n\nkfbmisc::tikzsave(\n  here::here(\"figures/rings-example/rings_pt_on_avg.pdf\"), \n  plot_rings, width = 8, height = 8 * 9 / 16\n)\nkfbmisc::tikzsave(\n  here::here(\"figures/rings-example/within_pt_on_avg.pdf\"), \n  plot_within, width = 8, height = 8 * 9 / 16\n)\n\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_line()`).\n\n\n\n(plot_both &lt;- ggplot() +\n  geom_point(\n    data = first_diff |&gt; filter(dist &lt;= 90),\n    aes(x = dist, y = d_y1), shape = 16, col = \"lightgrey\"\n  ) +\n  geom_hline(yintercept = reg[[(\"(Intercept)\")]], linetype = \"dotted\") +\n  # Within\n  geom_point(data = dots_within, aes(x = x, y = fit, color = \"#bf616a\"), size = 3, shape = 19) +\n  geom_line(data = line_within, aes(x = x, y = fit, color = \"#bf616a\", linetype = 1), linewidth = 1.5) +\n  # Rings\n  geom_point(data = dots, aes(x = x, y = fit, color = \"#5e81ac\"), size = 3, shape = 19) +\n  geom_line(data = line, aes(x = x, y = fit, color = \"#5e81ac\", linetype = 1), linewidth = 1.5) +\n  theme_kyle(base_size = 12) +\n  labs(\n    x = \"Distance from Nearest Treated\", y = \"Change in Outcome ($\\\\Delta Y$)\",\n    color = \"Estimation Method\"\n  ) +\n  scale_x_continuous(\n    breaks = c(0, 15, 30, 45, 60, 75, 90),\n    labels = c(\"Treated\", 15, 30, 45, 60, 75, 90)\n  ) +\n  scale_y_continuous(limits = c(1, 4.25)) +\n  scale_color_identity(\n    breaks = c(\"#bf616a\", \"#5e81ac\"),\n    labels = c(\"One Ring\", \"Multiple Rings\"),\n    guide = guide_legend(\n      override.aes = list(linetype = c(1, 1), shape = c(NA, NA), size = c(2, 2))\n    )\n  ) +\n  scale_linetype_identity(guide = \"none\") +\n  theme(\n    panel.grid.minor = element_blank(),\n    legend.position = c(0.8, 0.8),\n    legend.background = element_rect(fill = \"white\")\n    # legend.key.width = unit(4,\"cm\")\n  ) +\n  # Annotation: Counterfactual Trend\n  geom_curve(\n    data = data.frame(x = 35, y = 1.85, xend = 42.5, yend = reg[[(\"(Intercept)\")]] - 0.03),\n    mapping = aes(x = x, y = y, xend = xend, yend = yend),\n    arrow = arrow(30L, unit(0.1, \"inches\"), \"last\", \"closed\"),\n    inherit.aes = FALSE\n  ) +\n  geom_text(\n    data = data.frame(x = 1, y = 1.78, label = \"Counterfactual Trend Estimate\"),\n    mapping = aes(x = x, y = y, label = label), size = 4,\n    hjust = 0L, vjust = 0L, fontface = 3, inherit.aes = FALSE\n  ))\n\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_line()`).\n\n\n\n\n\n\n\n\n\n\nkfbmisc::tikzsave(\n  here::here(\"figures/rings-example/rings_v_within_pt_on_avg.pdf\"), plot_both,\n  width = 8, height = 8 * 9 / 16, dpi = 300\n)\n\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_line()`).",
    "crumbs": [
      "Rings Example",
      "Example single indicator vs. multiple rings"
    ]
  },
  {
    "objectID": "chc/analysis/index.html",
    "href": "chc/analysis/index.html",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "",
    "text": "Replication of Bailey and Goodman-Bacon (2015) with extension for event study framework including spillover effect controls.\nlibrary(tidyverse, warn.conflicts = FALSE)\nlibrary(sf)\n\nWarning: package 'sf' was built under R version 4.3.1\n\nlibrary(kfbmisc)\nlibrary(fixest)\nlibrary(did2s, quietly = TRUE)\n\nslides &lt;- TRUE\nh_w_ratio &lt;- 9 / 16",
    "crumbs": [
      "Chc",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "chc/analysis/index.html#data-cleaning",
    "href": "chc/analysis/index.html#data-cleaning",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "Data Cleaning",
    "text": "Data Cleaning\n\ndf &lt;- haven::read_dta(here::here(\"data/chc/aer_data.dta\")) |&gt;\n  # Remove LA, New York, Chicago\n  filter(\n    !(stfips == 36 & cofips == 61) &\n      !(stfips == 6 & cofips == 37) &\n      !(stfips == 17 & cofips == 31)\n  ) |&gt;\n  # Create urban dummy\n  group_by(fips) |&gt;\n  mutate(\n    `_urb` = sum(`_60pcturban` * (year == 1960), na.rm = TRUE)\n  ) |&gt;\n  ungroup() |&gt;\n  # cut every 25% with indicator from 0\n  mutate(\n    Durb = Hmisc::cut2(`_urb`, cuts = c(0, 1, 24.999, 49.999, 74.999, 110))\n  ) |&gt;\n  replace_na(list(chc_year_exp = 0))\n\nctr_pop &lt;- read_sf(here::here(\"data/2010_centpop/\")) |&gt;\n  mutate(fips = as.numeric(paste0(STATEFP, COUNTYFP))) |&gt;\n  select(fips) |&gt;\n  arrange(fips) |&gt;\n  st_transform(st_crs(2163))\n\ndf &lt;- df |&gt;\n  filter(fips != 12025) |&gt;\n  left_join(ctr_pop, by = \"fips\") |&gt;\n  st_as_sf()",
    "crumbs": [
      "Chc",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "chc/analysis/index.html#create-spillover-variables",
    "href": "chc/analysis/index.html#create-spillover-variables",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "Create Spillover variables",
    "text": "Create Spillover variables\n\n## helper function: for each year, calculate within\nwithin_x_treat &lt;- function(dist, year, chc_year_exp, geometry) {\n  y &lt;- min(year)\n\n  # Last term is because Bailey and Goodman-Bacon define it for chc's before 1974\n  treated &lt;- (chc_year_exp &lt;= y) & (chc_year_exp &gt; 0) & (chc_year_exp &lt;= 1974)\n\n\n  dist_mat &lt;- st_distance(geometry, geometry) |&gt;\n    units::set_units(\"mi\") |&gt;\n    units::drop_units()\n\n  within &lt;- (dist_mat &gt; 0) & (dist_mat &lt; dist)\n\n  return(as.numeric((within %*% treated) &gt; 0))\n}\n\n\n## helper function: find minimum year that within == 1, requires sorted!\nmin_year &lt;- function(year, within) {\n  if (any(within == 1)) {\n    idx &lt;- which(within == 1)[1]\n    y &lt;- year[idx]\n  } else {\n    y &lt;- 0\n  }\n\n  return(y)\n}\n\n\ndf_spill &lt;- df |&gt;\n  group_by(year) |&gt;\n  filter(year &lt;= 1988) |&gt;\n  # Create within indicator\n  mutate(\n    # CHC is included if added up to 1974\n    # Definition from Bailey and Goodman-Bacon\n    chc_open = if_else(chc_year_exp &lt;= 1974, chc_year_exp, 0),\n    # Create D_it\n    treat = as.numeric((chc_year_exp &lt;= year) & (chc_year_exp != 0)),\n    # Create S_it\n    within_25 = within_x_treat(25, year, chc_year_exp, geometry),\n    # S_it (1 - D_it)\n    within_25 = within_25 * (1 - treat)\n  ) |&gt;\n  ungroup() |&gt;\n  # Arrange panel by fips year\n  arrange(fips, year) |&gt;\n  group_by(fips) |&gt;\n  mutate(\n    # Create D_it^k's\n    rel_year = case_when(\n      chc_year_exp == 0 ~ -1,\n      chc_year_exp &gt;= 1975 ~ -1,\n      TRUE ~ year - chc_year_exp\n    ),\n    # Minimum year where S_it = 1\n    year_within_25 = min_year(year, within_25),\n    # Create S_it^k\n    spill_rel_year = case_when(\n      year_within_25 == 0 ~ -Inf,\n      treat == 1 ~ -Inf,\n      TRUE ~ year - year_within_25\n    ),\n    # max(D_it, S_it)\n    treat_or_spill = treat + within_25,\n    # Create trend variables for controls\n    Durb_trend = as.factor(paste(year, Durb, sep = \"_\")),\n    Durb_trend = as.factor(as.numeric(Durb_trend)),\n    stfips_trend = as.factor(paste(year, stfips, sep = \"_\")),\n    stfips_trend = as.factor(as.numeric(stfips_trend)),\n  ) |&gt;\n  ungroup()",
    "crumbs": [
      "Chc",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "chc/analysis/index.html#replicate-event-study",
    "href": "chc/analysis/index.html#replicate-event-study",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "Replicate Event Study",
    "text": "Replicate Event Study\n\nes_pts &lt;- df |&gt;\n  filter(year &lt;= 1988) |&gt;\n  st_drop_geometry() |&gt;\n  fixest::feols(\n    amr ~ i(exp1, ref = -1) + D_tot_act_md_t + D_60pctnonwhit_t + D_60pctrurf_t + D_60pcturban_t + D_pct59inclt3k_t + R_tranpcret + R_tranpcpa1 + H_bpc + H_hpc | fips + year + year^Durb + year^stfips,\n    weights = ~popwt\n  ) |&gt;\n  broom::tidy() |&gt;\n  filter(stringr::str_detect(term, \"exp1::\")) |&gt;\n  mutate(\n    time = as.numeric(stringr::str_remove(term, \"exp1::\"))\n  ) |&gt;\n  select(time, estimate, std.error) |&gt;\n  add_row(tibble(time = -1, estimate = 0, std.error = 0)) |&gt;\n  mutate(\n    ub = estimate + 1.96 * std.error,\n    lb = estimate - 1.96 * std.error\n  ) |&gt;\n  filter(time &lt;= 14)\n\nNOTE: 540 observations removed because of NA values (LHS: 90, RHS: 540, Weights: 90).",
    "crumbs": [
      "Chc",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "chc/analysis/index.html#modern-event-study",
    "href": "chc/analysis/index.html#modern-event-study",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "Modern Event Study",
    "text": "Modern Event Study\n\n# No spillover control, but modern estimator\nes_1 &lt;- df_spill |&gt;\n  sf::st_drop_geometry() |&gt;\n  drop_na(D_tot_act_md_t, D_60pctnonwhit_t, D_60pctrurf_t, D_60pcturban_t, D_pct59inclt3k_t, R_tranpcret, R_tranpcpa1, H_bpc, H_hpc, Durb_trend) |&gt;\n  did2s::did2s(\n    yname = \"amr\",\n    first_stage = ~ D_tot_act_md_t + D_60pctnonwhit_t + D_60pctrurf_t + D_60pcturban_t + D_pct59inclt3k_t + R_tranpcret + R_tranpcpa1 + H_bpc + H_hpc | fips + year + Durb_trend + stfips_trend,\n    second_stage = ~ i(rel_year, ref = -1),\n    treatment = \"treat\",\n    weights = \"popwt\",\n    cluster_var = \"stfips\"\n  )\n\nRunning Two-stage Difference-in-Differences\n - first stage formula `~ D_tot_act_md_t + D_60pctnonwhit_t + D_60pctrurf_t + D_60pcturban_t + D_pct59inclt3k_t + R_tranpcret + R_tranpcpa1 + H_bpc + H_hpc | fips + year + Durb_trend + stfips_trend`\n - second stage formula `~ i(rel_year, ref = -1)`\n - The indicator variable that denotes when treatment is on is `treat`\n - Standard errors will be clustered by `stfips`\n\n\nNOTE: The fixed-effects are not regular, they cannot be straightforwardly interpreted.\n\n# Preview es result\niplot(es_1)\n\n\n\n\n\n\n\n\n\n# Spillover controls\nes_2 &lt;- did2s::did2s(\n  data = df_spill |&gt;\n    sf::st_drop_geometry() |&gt;\n    # Filter out NAs\n    drop_na(D_tot_act_md_t, D_60pctnonwhit_t, D_60pctrurf_t, D_60pcturban_t, D_pct59inclt3k_t, R_tranpcret, R_tranpcpa1, H_bpc, H_hpc, Durb_trend, stfips_trend),\n  yname = \"amr\",\n  first_stage = ~ D_tot_act_md_t + D_60pctnonwhit_t + D_60pctrurf_t + D_60pcturban_t + D_pct59inclt3k_t + R_tranpcret + R_tranpcpa1 + H_bpc + H_hpc | fips + year + Durb_trend + stfips_trend,\n  second_stage = ~ i(rel_year) + i(spill_rel_year, ref = -Inf),\n  treatment = \"treat_or_spill\",\n  weights = \"popwt\",\n  cluster_var = \"stfips\"\n)\n\nRunning Two-stage Difference-in-Differences\n - first stage formula `~ D_tot_act_md_t + D_60pctnonwhit_t + D_60pctrurf_t + D_60pcturban_t + D_pct59inclt3k_t + R_tranpcret + R_tranpcpa1 + H_bpc + H_hpc | fips + year + Durb_trend + stfips_trend`\n - second stage formula `~ i(rel_year) + i(spill_rel_year, ref = -Inf)`\n - The indicator variable that denotes when treatment is on is `treat_or_spill`\n - Standard errors will be clustered by `stfips`\n\n\nNOTE: The fixed-effects are not regular, they cannot be straightforwardly interpreted.\n\niplot(es_2)\n\n\n\n\n\n\n\n\n\nes_pts_combined &lt;- broom::tidy(es_2) |&gt;\n  mutate(\n    # Split term to variable and relative time\n    term_split = str_split(term, \"::\"),\n    term = unlist(lapply(term_split, \\(x) x[1])),\n    time = unlist(lapply(term_split, \\(x) x[2])),\n    time = as.numeric(time),\n    # Confidence interval\n    ub = estimate + 1.96 * std.error,\n    lb = estimate - 1.96 * std.error,\n    # Term for plotting\n    group = case_when(\n      term == \"rel_year\" ~ \"Treatment Effect\",\n      term == \"spill_rel_year\" ~ \"Spillover On Control\",\n    )\n  ) |&gt;\n  # Filter years to match original\n  filter(time &lt;= 14 & time &gt;= -7) |&gt;\n  # Shift for plotting\n  mutate(time = if_else(term == \"rel_year\", time + 0.2, time - 0.2))\n\n# Add -1 for plotting\nes_pts_combined &lt;- bind_rows(\n  es_pts_combined,\n  tibble(time = c(-1.2, -0.8), estimate = c(0, 0), ub = c(0, 0), lb = c(0, 0), group = c(\"Spillover On Control\", \"Treatment Effect\"))\n)",
    "crumbs": [
      "Chc",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "chc/analysis/index.html#export-figures",
    "href": "chc/analysis/index.html#export-figures",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "Export figures",
    "text": "Export figures\n\n# treatment effect original\n(es_plot_original &lt;- ggplot(es_pts) +\n  geom_vline(xintercept = -0.5, color = \"grey50\") +\n  geom_hline(yintercept = 0, color = \"black\") +\n  geom_point(aes(x = time, y = estimate), color = \"#bf616a\") +\n  geom_errorbar(aes(x = time, ymin = lb, ymax = ub), color = \"#bf616a\", alpha = 0.8) +\n  theme_kyle(base_size = 12) +\n  theme(title = element_text(size = 12, margin = margin(b = 0, unit = \"pt\"))) +\n  scale_x_continuous(minor_breaks = seq(-7, 14, 1)) +\n  scale_y_continuous(minor_breaks = seq(-75, 50, 5), limits = c(-75, 50)) +\n  labs(y = \"Deaths per 100,000 persons\", x = \"Years since CHC establishment\", color = NULL))\n\n\n\n\n\n\n\nkfbmisc::tikzsave(\n  here::here(\"figures/chc-es_original_slides.pdf\"), \n  es_plot_original, width = 8, height = 8 * h_w_ratio\n)\nkfbmisc::tikzsave(\n  here::here(\"figures/chc-es_original.pdf\"), \n  es_plot_original, width = 8, height = 5\n)\n\n\n(es_plot_combined &lt;- ggplot(es_pts_combined) +\n  geom_vline(xintercept = -0.5, color = \"grey50\") +\n  geom_hline(yintercept = 0, color = \"black\") +\n  geom_point(aes(x = time, y = estimate, color = group)) +\n  geom_errorbar(aes(x = time, ymin = lb, ymax = ub, color = group), alpha = 0.8) +\n  kfbmisc::theme_kyle(base_size = 12) +\n  theme(\n    legend.position = \"inside\",\n    legend.position.inside = c(0.165, 0.25),\n    legend.spacing.x = unit(0, \"pt\"),\n    legend.spacing.y = unit(0, \"pt\"),\n    legend.background = element_rect(fill = \"white\"),\n    panel.grid.minor.y = element_blank()\n  ) +\n  scale_shape_manual(values = c(16, 18)) +\n  scale_color_manual(values = c(\"#5e81ac\", \"#bf616a\")) +\n  scale_x_continuous(minor_breaks = seq(-7, 14, 1)) +\n  scale_y_continuous(minor_breaks = seq(-75, 45, 50), limits = c(-75, 50)) +\n  labs(y = \"Deaths per 100,000 persons\", x = \"Years since CHC establishment\", color = NULL))\n\n\n\n\n\n\n\n\n\nkfbmisc::tikzsave(\n  here::here(\"figures/chc-es_combined_slides.pdf\"),\n  es_plot_combined,\n  width = 8, height = 8 * h_w_ratio\n)\nkfbmisc::tikzsave(\n  here::here(\"figures/chc-es_combined.pdf\"),\n  es_plot_combined,\n  width = 8, height = 5\n)",
    "crumbs": [
      "Chc",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "OZ/replication/index.html",
    "href": "OZ/replication/index.html",
    "title": "Replication of Chen, Glaeser, and Wessel (2023)",
    "section": "",
    "text": "library(tidyverse, warn.conflicts = FALSE)\nlibrary(arrow)\nlibrary(here)\nlibrary(fixest)\nlibrary(broom)",
    "crumbs": [
      "OZ",
      "Replication of Chen, Glaeser, and Wessel (2023)"
    ]
  },
  {
    "objectID": "OZ/replication/index.html#load-data",
    "href": "OZ/replication/index.html#load-data",
    "title": "Replication of Chen, Glaeser, and Wessel (2023)",
    "section": "Load Data",
    "text": "Load Data\n\nzillow_data &lt;- read_feather(here(\"data/OZ/tracts_data.feather\"))\nzillow_data &lt;- zillow_data |&gt; filter(year != 2020)\nzillow_data$tract &lt;- factor(zillow_data$tract)\nzillow_data$treat_x_post &lt;- zillow_data$treatment * zillow_data$post",
    "crumbs": [
      "OZ",
      "Replication of Chen, Glaeser, and Wessel (2023)"
    ]
  },
  {
    "objectID": "OZ/replication/index.html#classic-difference-in-differences",
    "href": "OZ/replication/index.html#classic-difference-in-differences",
    "title": "Replication of Chen, Glaeser, and Wessel (2023)",
    "section": "Classic Difference-in-Differences",
    "text": "Classic Difference-in-Differences\n\nfit_did_fixest &lt;- function(data, fmla, pretest_fmla, pretest_cols) {\n  model_pretest &lt;- fixest::feols(\n    fml = pretest_fmla,\n    data = data, cluster = ~state_abbr\n  )\n\n  pretest &lt;- wald(model_pretest, keep = pretest_cols)\n\n  model &lt;- fixest::feols(\n    fml = fmla,\n    data = data, cluster = ~state_abbr\n  )\n\n  return(list(\n    model_pretest = model_pretest,\n    lh_pretest = pretest,\n    model = model\n  ))\n}\n\n\nNo Covariates\n\nzillow_model &lt;- fit_did_fixest(\n  data = zillow_data,\n  fmla = annual_change ~ treatment_and_post | year + tract,\n  pretest_fmla = annual_change ~ \n    i(treatment, i.year, ref = FALSE, ref2 = 2017) | \n    year + tract,\n  pretest_cols = c(\"treatment::TRUE:year::2014\", \"treatment::TRUE:year::2015\", \"treatment::TRUE:year::2016\")\n)\n\nWald test, H0: joint nullity of treatment::TRUE:year::2014, treatment::TRUE:year::2015 and treatment::TRUE:year::2016\n stat = 0.101862, p-value = 0.958974, on 3 and 101,340 DoF, VCOV: Clustered (state_abbr).\n\nzillow_model\n\n$model_pretest\nOLS estimation, Dep. Var.: annual_change\nObservations: 121,620 \nFixed-effects: year: 6,  tract: 20,270\nStandard-errors: Clustered (state_abbr) \n                           Estimate Std. Error  t value Pr(&gt;|t|) \ntreatment::TRUE:year::2014 0.010515   0.253057 0.041551  0.96702 \ntreatment::TRUE:year::2015 0.024419   0.187918 0.129947  0.89713 \ntreatment::TRUE:year::2016 0.118437   0.235842 0.502190  0.61774 \ntreatment::TRUE:year::2018 0.395984   0.333319 1.188002  0.24045 \ntreatment::TRUE:year::2019 0.300182   0.198673 1.510937  0.13710 \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 7.09563     Adj. R2: 0.050177\n                Within R2: 5.614e-5\n\n$lh_pretest\n$lh_pretest$stat\n[1] 0.1018617\n\n$lh_pretest$p\n[1] 0.9589745\n\n$lh_pretest$df1\n[1] 3\n\n$lh_pretest$df2\n[1] 101340\n\n$lh_pretest$vcov\n[1] \"Clustered (state_abbr)\"\n\n\n$model\nOLS estimation, Dep. Var.: annual_change\nObservations: 121,620 \nFixed-effects: year: 6,  tract: 20,270\nStandard-errors: Clustered (state_abbr) \n                   Estimate Std. Error t value Pr(&gt;|t|) \ntreatment_and_post  0.30974   0.202635 1.52856  0.13268 \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 7.09565     Adj. R2: 0.050209\n                Within R2: 5.08e-5 \n\nmodel_results &lt;- tidy(zillow_model$model)\ntau &lt;- zillow_model$model$estimate\nse &lt;- zillow_model$model$std.error\ntstat &lt;- zillow_model$model$statistics\npval &lt;- zillow_model$model$p.value\n\n\n\nSparse covariates\n\nzillow_model_cov_sp &lt;- fit_did_fixest(\n  data = zillow_data,\n  fmla = annual_change ~ 1 + treatment * post + i(year, log_median_household_income, ref = 2017) + i(year, pct_white, ref = 2017) | year + tract,\n  pretest_fmla = annual_change ~ 1 + i(treatment, i.year, ref = FALSE) + i(year, log_median_household_income, ref = 2017) + i(year, pct_white, ref = 2017) | year + tract,\n  pretest_cols = c(\"treatment::TRUE:year::2014\", \"treatment::TRUE:year::2015\", \"treatment::TRUE:year::2016\")\n)\n\nWald test, H0: joint nullity of treatment::TRUE:year::2014, treatment::TRUE:year::2015 and treatment::TRUE:year::2016\n stat = 0.227689, p-value = 0.877179, on 3 and 101,329 DoF, VCOV: Clustered (state_abbr).\n\n\nThe variables 'treatmentTRUE' and 'post' have been removed because of collinearity (see $collin.var).\n\n\n\n\nFull Covariates\n\nzillow_model_cov &lt;- fit_did_fixest(\n  data = zillow_data,\n  fmla = annual_change ~ 1 + treatment * post + i(year, log_median_household_income, ref = 2017) + i(year, total_housing, ref = 2017) + i(year, pct_white, ref = 2017) + i(year, pct_higher_ed, ref = 2017) + i(year, pct_rent, ref = 2017) + i(year, pct_native_hc_covered, ref = 2017) + i(year, pct_poverty, ref = 2017) + i(year, pct_supplemental_income, ref = 2017) + i(year, pct_employed, ref = 2017) | year + tract,\n  pretest_fmla = annual_change ~ 1 + treatment * year + i(year, log_median_household_income, ref = 2017) + i(year, total_housing, ref = 2017) + i(year, pct_white, ref = 2017) + i(year, pct_higher_ed, ref = 2017) + i(year, pct_rent, ref = 2017) + i(year, pct_native_hc_covered, ref = 2017) + i(year, pct_poverty, ref = 2017) + i(year, pct_supplemental_income, ref = 2017) + i(year, pct_employed, ref = 2017) | year + tract,\n  pretest_cols = c(\"treatment::TRUE:year::2014\", \"treatment::TRUE:year::2015\", \"treatment::TRUE:year::2016\")\n)\n\nThe variables 'treatmentTRUE' and 'year' have been removed because of collinearity (see $collin.var).\n\n\nThe variables 'treatmentTRUE' and 'post' have been removed because of collinearity (see $collin.var).",
    "crumbs": [
      "OZ",
      "Replication of Chen, Glaeser, and Wessel (2023)"
    ]
  },
  {
    "objectID": "OZ/replication/index.html#callway-and-santanna",
    "href": "OZ/replication/index.html#callway-and-santanna",
    "title": "Replication of Chen, Glaeser, and Wessel (2023)",
    "section": "Callway and Sant’Anna",
    "text": "Callway and Sant’Anna\n\nlibrary(did)\nzillow_data$tract &lt;- as.numeric(zillow_data$tract)\n\nout &lt;- att_gt(\n  yname = \"annual_change\",\n  tname = \"year\",\n  idname = \"tract\",\n  gname = \"first_treat\",\n  xformla = ~ log_median_household_income + total_housing +\n    pct_white + pct_higher_ed + pct_rent +\n    pct_native_hc_covered + pct_poverty +\n    pct_supplemental_income + pct_employed,\n  data = zillow_data,\n  bstrap = FALSE,\n  cband = FALSE\n)\ndid::aggte(out, type = \"simple\")\n\n\nCall:\ndid::aggte(MP = out, type = \"simple\")\n\nReference: Callaway, Brantly and Pedro H.C. Sant'Anna.  \"Difference-in-Differences with Multiple Time Periods.\" Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; \n\n    ATT    Std. Error     [ 95%  Conf. Int.] \n 0.3575        0.2314    -0.0961      0.8111 \n\n\n---\nSignif. codes: `*' confidence band does not cover 0\n\nControl Group:  Never Treated,  Anticipation Periods:  0\nEstimation Method:  Doubly Robust",
    "crumbs": [
      "OZ",
      "Replication of Chen, Glaeser, and Wessel (2023)"
    ]
  },
  {
    "objectID": "OZ/replication/index.html#doubly-robust",
    "href": "OZ/replication/index.html#doubly-robust",
    "title": "Replication of Chen, Glaeser, and Wessel (2023)",
    "section": "Doubly Robust",
    "text": "Doubly Robust\n\n# library(DRDID)\n# two_periods &lt;- read_feather(here(\"data/OZ/two_periods.feather\"))\n#\n# two_periods$treatment &lt;- as.numeric(two_periods$treatment)\n# two_periods$tract &lt;- as.numeric(two_periods$tract)\n#\n# drdid_out &lt;- drdid(yname = \"annual_change\", tname = \"year\", idname = \"tract\", dname = \"treatment\",\n#              xformla= ~log_median_household_income + total_housing +\n#     pct_white + pct_higher_ed + pct_rent +\n#     pct_native_hc_covered + pct_poverty +\n#     pct_supplemental_income + pct_employed,\n#              data = two_periods, panel = TRUE)",
    "crumbs": [
      "OZ",
      "Replication of Chen, Glaeser, and Wessel (2023)"
    ]
  },
  {
    "objectID": "OZ/replication/index.html#matched-pair-design",
    "href": "OZ/replication/index.html#matched-pair-design",
    "title": "Replication of Chen, Glaeser, and Wessel (2023)",
    "section": "Matched Pair Design",
    "text": "Matched Pair Design\n\npair_diff_panel &lt;- read_feather(here(\"data/OZ/pair_diff_panel.feather\"))\n\npair_diff_panel &lt;- pair_diff_panel |&gt; filter(year != 2020)\npair_diff_panel$post &lt;- pair_diff_panel$year == \"2018\"\npair_diff_panel$year &lt;- relevel(factor(pair_diff_panel$year), ref = \"2017\")\n\nmodel_diff &lt;- fixest::feols(\n  treated_minus_untreated ~ i(post, ref = FALSE) | pair_id,\n  data = pair_diff_panel\n)",
    "crumbs": [
      "OZ",
      "Replication of Chen, Glaeser, and Wessel (2023)"
    ]
  },
  {
    "objectID": "OZ/spillovers/index.html",
    "href": "OZ/spillovers/index.html",
    "title": "Adding spillovers to Opportunity Zone analysis",
    "section": "",
    "text": "Opportunity Zone analysis where I run Selected vs. Eligible but Not Selected and have spillovers on adjacent census tracts. See if differences in effect is due to identification strategy.\nlibrary(tidyverse, warn.conflicts = FALSE)\nlibrary(sf)\n\nWarning: package 'sf' was built under R version 4.3.1\n\nlibrary(units)\n\nWarning: package 'units' was built under R version 4.3.1\n\nlibrary(arrow)\nlibrary(here)\nlibrary(fixest)\nlibrary(broom)\nFind distance to nearest treated:\ngeos &lt;- read_sf(here(\"data/OZ/tracts/all_tracts_with_status.shp\"))\ngeos &lt;- geos |&gt;\n    st_point_on_surface() |&gt;\n    mutate(\n        status = ifelse(is.na(status), \"Ineligible\", status),\n        intptlat = as.numeric(intptlat),\n        intptlon = as.numeric(intptlon),\n    )\n\nWarning: st_point_on_surface assumes attributes are constant over geometries\n\n\nWarning in st_point_on_surface.sfc(st_geometry(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\nCode is inefficient because of memory concerns\nselected &lt;- geos[geos$status == \"Selected\", ]\ngeos$distance_to_nearest &lt;- kfbmisc::st_nearest_distance_rcpp(geos, selected)[, 2]\n\n[1] \"Distance in miles. To use kilometers use option `unit == 'km'`\"\n\ngeos &lt;- geos |&gt;\n    st_as_sf() |&gt;\n    st_drop_geometry() |&gt;\n    mutate(tract = as.character(geoid)) |&gt;\n    select(tract, status, distance_to_nearest)\nLoading the data and merging with spatial data\ntracts &lt;- read_feather(here(\"data/OZ/tracts_data.feather\")) |&gt; \n    filter(year != 2020) |&gt; \n    left_join(geos, by = \"tract\")",
    "crumbs": [
      "OZ",
      "Adding spillovers to Opportunity Zone analysis"
    ]
  },
  {
    "objectID": "OZ/spillovers/index.html#regression-analysis",
    "href": "OZ/spillovers/index.html#regression-analysis",
    "title": "Adding spillovers to Opportunity Zone analysis",
    "section": "Regression Analysis",
    "text": "Regression Analysis\n\nSelected vs. Eligible\n\n(eligible &lt;- feols(\n    annual_change ~ treatment_and_post + \n        i(year, log_median_household_income, ref = 2017) + \n        i(year, total_housing, ref = 2017) + \n        i(year, pct_white, ref = 2017) + \n        i(year, pct_higher_ed, ref = 2017) + \n        i(year, pct_rent, ref = 2017) + \n        i(year, pct_native_hc_covered, ref = 2017) + \n        i(year, pct_poverty, ref = 2017) + \n        i(year, pct_supplemental_income, ref = 2017) + \n        i(year, pct_employed, ref = 2017) | \n        year + tract,\n    data = tracts, cluster = ~state_abbr\n))\n\nOLS estimation, Dep. Var.: annual_change\nObservations: 121,620 \nFixed-effects: year: 6,  tract: 20,270\nStandard-errors: Clustered (state_abbr) \n                                        Estimate Std. Error   t value\ntreatment_and_post                      0.303266   0.166103  1.825776\nyear::2014:log_median_household_income 10.311156   3.307763  3.117259\nyear::2015:log_median_household_income  0.352815   0.632039  0.558217\nyear::2016:log_median_household_income  1.241923   0.898994  1.381459\nyear::2018:log_median_household_income -1.802364   0.899350 -2.004073\nyear::2019:log_median_household_income -4.599137   1.183967 -3.884515\nyear::2014:total_housing               -0.000483   0.000273 -1.767482\nyear::2015:total_housing               -0.000045   0.000131 -0.341487\n                                         Pr(&gt;|t|)    \ntreatment_and_post                     0.07385888 .  \nyear::2014:log_median_household_income 0.00302404 ** \nyear::2015:log_median_household_income 0.57918742    \nyear::2016:log_median_household_income 0.17328039    \nyear::2018:log_median_household_income 0.05049443 .  \nyear::2019:log_median_household_income 0.00030188 ***\nyear::2014:total_housing               0.08324988 .  \nyear::2015:total_housing               0.73416776    \n... 38 coefficients remaining (display them with summary() or use argument n)\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 7.00077     Adj. R2: 0.07503 \n                Within R2: 0.026614\n\n\n\n\nSelected vs. Nearby\n\npair_diff_panel &lt;- read_feather(here(\"data/OZ/pair_diff_panel.feather\"))\n\npair_diff_panel &lt;- pair_diff_panel |&gt; \n    filter(year != 2020) |&gt; \n    mutate(\n        treatment_and_post = as.numeric(year == \"2018\"),\n        year = relevel(factor(year), ref = \"2017\")\n    )\n\n\n(nearby &lt;- fixest::feols(\n    treated_minus_untreated ~ treatment_and_post | pair_id,\n    data = pair_diff_panel\n))\n\nOLS estimation, Dep. Var.: treated_minus_untreated\nObservations: 15,882 \nFixed-effects: pair_id: 2,647\nStandard-errors: Clustered (pair_id) \n                   Estimate Std. Error t value  Pr(&gt;|t|)    \ntreatment_and_post 0.647793   0.245663 2.63691 0.0084153 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 9.44519     Adj. R2: -0.14431 \n                Within R2:  6.529e-4",
    "crumbs": [
      "OZ",
      "Adding spillovers to Opportunity Zone analysis"
    ]
  },
  {
    "objectID": "OZ/spillovers/index.html#spillover-analysis",
    "href": "OZ/spillovers/index.html#spillover-analysis",
    "title": "Adding spillovers to Opportunity Zone analysis",
    "section": "Spillover Analysis",
    "text": "Spillover Analysis\n\ntracts$within_half &lt;- tracts$distance_to_nearest &lt;= 1 / 2 & tracts$distance_to_nearest &gt; 0\ntracts$within_1 &lt;- tracts$distance_to_nearest &lt;= 1 & tracts$distance_to_nearest &gt; 1 / 2\ntracts$within_half_and_post &lt;- as.numeric(tracts$within_half & tracts$year &gt;= 2018)\ntracts$within_1_and_post &lt;- as.numeric(tracts$within_1 & tracts$year &gt;= 2018)\n\n\n(spill &lt;- feols(\n    annual_change ~ \n        treatment_and_post + within_half_and_post + within_1_and_post + \n        i(year, log_median_household_income, ref = 2017) + \n        i(year, total_housing, ref = 2017) + \n        i(year, pct_white, ref = 2017) + \n        i(year, pct_higher_ed, ref = 2017) + \n        i(year, pct_rent, ref = 2017) + \n        i(year, pct_native_hc_covered, ref = 2017) + \n        i(year, pct_poverty, ref = 2017) + \n        i(year, pct_supplemental_income, ref = 2017) + \n        i(year, pct_employed, ref = 2017) | \n        year + tract,\n    data = tracts, cluster = ~state_abbr\n))\n\nOLS estimation, Dep. Var.: annual_change\nObservations: 121,620 \nFixed-effects: year: 6,  tract: 20,270\nStandard-errors: Clustered (state_abbr) \n                                        Estimate Std. Error   t value\ntreatment_and_post                      0.178783   0.169177  1.056782\nwithin_half_and_post                   -1.056679   0.361845 -2.920253\nwithin_1_and_post                      -0.743020   0.192220 -3.865464\nyear::2014:log_median_household_income 10.311156   3.307791  3.117234\nyear::2015:log_median_household_income  0.352815   0.632044  0.558212\nyear::2016:log_median_household_income  1.241923   0.899001  1.381447\nyear::2018:log_median_household_income -1.747633   0.888325 -1.967336\nyear::2019:log_median_household_income -4.544406   1.184462 -3.836684\n                                         Pr(&gt;|t|)    \ntreatment_and_post                     0.29569047    \nwithin_half_and_post                   0.00523418 ** \nwithin_1_and_post                      0.00032057 ***\nyear::2014:log_median_household_income 0.00302426 ** \nyear::2015:log_median_household_income 0.57919053    \nyear::2016:log_median_household_income 0.17328386    \nyear::2018:log_median_household_income 0.05470491 .  \nyear::2019:log_median_household_income 0.00035093 ***\n... 40 coefficients remaining (display them with summary() or use argument n)\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\nRMSE: 6.99994     Adj. R2: 0.07523 \n                Within R2: 0.026844",
    "crumbs": [
      "OZ",
      "Adding spillovers to Opportunity Zone analysis"
    ]
  },
  {
    "objectID": "OZ/spillovers/index.html#results-table",
    "href": "OZ/spillovers/index.html#results-table",
    "title": "Adding spillovers to Opportunity Zone analysis",
    "section": "Results Table",
    "text": "Results Table\n\n(table &lt;- fixest::esttex(eligible, nearby, spill,\n    dict = c(treatment_and_post = \"Treat X Post\", within_half_and_post = \"&lt; 1/2mi. X Post\", within_1_and_post = \"&lt; 1mi. X Post\"),\n    keep = c(\"Treat X Post\", \"&lt; 1/2mi. X Post\", \"&lt; 1mi. X Post\")\n))\n\n\\begin{table}[htbp]\n   \\caption{no title}\n   \\centering\n   \\begin{tabular}{lccc}\n      \\tabularnewline \\midrule \\midrule\n      Dependent Variables: & annual\\_change  & treated\\_minus\\_untreated   & annual\\_change\\\\   \n      Model:               & (1)             & (2)                         & (3)\\\\  \n      \\midrule\n      \\emph{Variables}\\\\\n      Treat X Post         & 0.3033$^{*}$    & 0.6478$^{***}$              & 0.1788\\\\   \n                           & (0.1661)        & (0.2457)                    & (0.1692)\\\\   \n      &lt; 1/2mi. X Post      &                 &                             & -1.057$^{***}$\\\\   \n                           &                 &                             & (0.3618)\\\\   \n      &lt; 1mi. X Post        &                 &                             & -0.7430$^{***}$\\\\   \n                           &                 &                             & (0.1922)\\\\   \n      \\midrule\n      \\emph{Fixed-effects}\\\\\n      year                 & Yes             &                             & Yes\\\\  \n      tract                & Yes             &                             & Yes\\\\  \n      pair\\_id             &                 & Yes                         & \\\\  \n      \\midrule\n      \\emph{Fit statistics}\\\\\n      Observations         & 121,620         & 15,882                      & 121,620\\\\  \n      R$^2$                & 0.22957         & 0.04642                     & 0.22975\\\\  \n      Within R$^2$         & 0.02661         & 0.00065                     & 0.02684\\\\  \n      \\midrule \\midrule\n      \\multicolumn{4}{l}{\\emph{Signif. Codes: ***: 0.01, **: 0.05, *: 0.1}}\\\\\n   \\end{tabular}\n\\end{table}\n\n\n\ntable = as.character(table)\ntable[10:15] |&gt;\n    stringr::str_replace(\"X\", \"$\\\\\\\\times$\") |&gt;\n    paste0(\"\\n\") |&gt;\n    cat(file = here(\"tables/OZ_replication.tex\"))\n\ncat(paste0(table[10:15], \"\\n\"), file = here(\"tables/OZ_replication.tex\"))",
    "crumbs": [
      "OZ",
      "Adding spillovers to Opportunity Zone analysis"
    ]
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Difference-in-Differences with Spatial Spillovers",
    "section": "",
    "text": "Kyle Butts1  1University of Colorado: Boulder\nPaper | Five-minute Summary\n\n\nEmpirical work often uses treatment assigned following geographic boundaries. When the effects of treatment cross over borders, classical difference-in-differences estimation produces biased estimates for the average treatment effect. In this paper, I introduce a potential outcomes framework to model spillover effects and decompose the estimate’s bias in two parts: (1) the control group no longer identifies the counterfactual trend because their outcomes are affected by treatment and (2) changes in treated units’ outcomes reflect the effect of their own treatment status and the effect from the treatment status of ``close’’ units. I propose estimation strategies that can remove both sources of bias and semi-parametrically estimate the spillover effects themselves including in settings with staggered treatment timing. To highlight the importance of spillover effects, I revisit analyses of three place-based interventions.\n\n\n\nFigure 1: Comparison of Single vs. Multiple Rings Estimation of Spillover Effects\n\ncode/rings-example/rings_example.R\n\nFigure 2: TVA Effective Sample and Spillover Variables Table 1: Effects of Tennessee Valley Authority on Decadel Growth - code/tva/tva-data-build.do - code/tva/analysis.R\nTable B1: Effects of Opportunity Zones on Annual Home Price Growth - code/OZ/replication.R - code/OZ/spillovers.R\nFigure C1: Total and Spillover Effects of Community Health Centers - code/CHC/analysis.R\n\n\n\n@article{butts2023difference,\n  title={Difference-in-Differences Estimation with Spatial Spillovers},\n  author={Butts, Kyle},\n  journal={arXiv preprint arXiv:2105.03737},\n  year={2023}\n}"
  },
  {
    "objectID": "index.html#abstract",
    "href": "index.html#abstract",
    "title": "Difference-in-Differences with Spatial Spillovers",
    "section": "",
    "text": "Empirical work often uses treatment assigned following geographic boundaries. When the effects of treatment cross over borders, classical difference-in-differences estimation produces biased estimates for the average treatment effect. In this paper, I introduce a potential outcomes framework to model spillover effects and decompose the estimate’s bias in two parts: (1) the control group no longer identifies the counterfactual trend because their outcomes are affected by treatment and (2) changes in treated units’ outcomes reflect the effect of their own treatment status and the effect from the treatment status of ``close’’ units. I propose estimation strategies that can remove both sources of bias and semi-parametrically estimate the spillover effects themselves including in settings with staggered treatment timing. To highlight the importance of spillover effects, I revisit analyses of three place-based interventions."
  },
  {
    "objectID": "index.html#replication",
    "href": "index.html#replication",
    "title": "Difference-in-Differences with Spatial Spillovers",
    "section": "",
    "text": "Figure 1: Comparison of Single vs. Multiple Rings Estimation of Spillover Effects\n\ncode/rings-example/rings_example.R\n\nFigure 2: TVA Effective Sample and Spillover Variables Table 1: Effects of Tennessee Valley Authority on Decadel Growth - code/tva/tva-data-build.do - code/tva/analysis.R\nTable B1: Effects of Opportunity Zones on Annual Home Price Growth - code/OZ/replication.R - code/OZ/spillovers.R\nFigure C1: Total and Spillover Effects of Community Health Centers - code/CHC/analysis.R"
  },
  {
    "objectID": "index.html#citation",
    "href": "index.html#citation",
    "title": "Difference-in-Differences with Spatial Spillovers",
    "section": "",
    "text": "@article{butts2023difference,\n  title={Difference-in-Differences Estimation with Spatial Spillovers},\n  author={Butts, Kyle},\n  journal={arXiv preprint arXiv:2105.03737},\n  year={2023}\n}"
  },
  {
    "objectID": "TVA/analysis/index.html",
    "href": "TVA/analysis/index.html",
    "title": "Kline and Moretti (2014)",
    "section": "",
    "text": "Replicate Table 3 of Kline and Moretti (2014) with extension that includes spillover control using rings method\nlibrary(tidyverse, warn.conflicts = FALSE)\nlibrary(fixest)\nlibrary(haven)\nlibrary(sf)\nlibrary(Rcpp)\nlibrary(RcppArmadillo)\nlibrary(kfbmisc)\n\n# Helper functions\nsource(here::here(\"code/TVA/helpers.R\"))\nsource(here::here(\"code/TVA/helper-conley.R\"))\nh_w_ratio &lt;- 9 / 16\ndf &lt;- read_dta(here::here(\"data/tva/build.dta\")) |&gt;\n  mutate(\n    fips = sprintf(\"%05d\", fipstat * 1000 + fipcnty)\n  )\n\ncounties &lt;- sf::read_sf(here::here(\"data/2010_county.geojson\")) |&gt;\n  mutate(fips = paste0(STATEFP10, COUNTYFP10)) |&gt;\n  select(state = STATEFP10, county = COUNTYFP10, fips) |&gt;\n  rmapshaper::ms_simplify(keep = 0.05)\n\nThe legacy packages maptools, rgdal, and rgeos, underpinning this package\nwill retire shortly. Please refer to R-spatial evolution reports on\nhttps://r-spatial.org/r/2023/05/15/evolution4.html for details.\nThis package is now running under evolution status 0 \n\n# Create TVA shape\ntva_fips &lt;- scan(here::here(\"data/tva/tvacounties.txt\"), character())\n\ntva &lt;- counties |&gt;\n  filter(fips %in% tva_fips) |&gt;\n  summarize()\n\ndist_mat &lt;- st_distance(counties |&gt; st_point_on_surface(), tva)\n\nWarning: st_point_on_surface assumes attributes are constant over geometries\n\ncounties$dist_to_tva &lt;- as.vector(units::drop_units(units::set_units(dist_mat, \"mi\")))\n\nsetFixest_fml(\n  ..controls = ~ lnelevmax + lnelevrang + lnarea + lnpop20 + lnpop20sq + lnpop30 + lnpop30sq + popdifsq + agrshr20 + agrshr20sq + agrshr30 + agrshr30sq + manufshr20 + manufshr30 + lnwage20 + lnwage30 + lntwage30 + lnemp20 + lnemp30 + urbshare20 + urbshare30 + lnfaval20 + lnfaval30 + lnmedhsval30 + lnmedrnt30 + white20 + white20sq + white30 + white30sq + pctil20 + pctil30 + urate30 + fbshr20 + fbshr30 + PRADIO30 + nowage20dum + nowage30dum + notwage30dum\n)\n\ncontrols &lt;- c(\"lnelevmax\", \"lnelevrang\", \"lnarea\", \"lnpop20\", \"lnpop20sq\", \"lnpop30\", \"lnpop30sq\", \"popdifsq\", \"agrshr20\", \"agrshr20sq\", \"agrshr30\", \"agrshr30sq\", \"manufshr20\", \"manufshr30\", \"lnwage20\", \"lnwage30\", \"lntwage30\", \"lnemp20\", \"lnemp30\", \"urbshare20\", \"urbshare30\", \"lnfaval20\", \"lnfaval30\", \"lnmedhsval30\", \"lnmedrnt30\", \"white20\", \"white20sq\", \"white30\", \"white30sq\", \"pctil20\", \"pctil30\", \"urate30\", \"fbshr20\", \"fbshr30\", \"PRADIO30\", \"nowage20dum\", \"nowage30dum\", \"notwage30dum\")\nCreate spillover variables\n# lat-long of county centroids\ncounties[, c(\"long\", \"lat\")] &lt;- counties |&gt;\n  st_transform(4326) |&gt;\n  st_point_on_surface() |&gt;\n  st_coordinates()\n\nWarning: st_point_on_surface assumes attributes are constant over geometries\n\n\nWarning in st_point_on_surface.sfc(st_geometry(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n\n# Create spillover variable donuts\ndf_reg &lt;- df |&gt;\n  left_join(counties |&gt; st_drop_geometry(), by = \"fips\") |&gt;\n  mutate(\n    tva_0_100 = !tva & dist_to_tva &gt;= 0 & dist_to_tva &lt; 100,\n    tva_0_50 = !tva & dist_to_tva &gt;= 0 & dist_to_tva &lt; 50,\n    tva_50_100 = !tva & dist_to_tva &gt;= 50 & dist_to_tva &lt; 100,\n    tva_100_150 = !tva & dist_to_tva &gt;= 100 & dist_to_tva &lt; 150,\n    tva_150_200 = !tva & dist_to_tva &gt;= 150 & dist_to_tva &lt; 200\n  )\nLogit for subsample\ntva_logit &lt;- fixest::femlm(tva ~ ..controls, data = df_reg, family = \"logit\")\n\nNOTE: 122 observations removed because of NA values (RHS: 122).\n\ndf_reg &lt;- df_reg |&gt;\n  mutate(\n    phat = predict(tva_logit, df_reg),\n    keep = phat &gt; quantile(phat, probs = c(0.25), na.rm = TRUE)\n  )\nFigure of counties and spillover variable\nfips_in_sample &lt;- df_reg |&gt;\n  drop_na(!!c(controls)) |&gt;\n  filter(keep == TRUE) |&gt;\n  pull(fips)\n\nrings &lt;- counties |&gt;\n  filter(fips %in% fips_in_sample) |&gt;\n  mutate(\n    spill = case_when(\n      0 &lt; dist_to_tva & dist_to_tva &lt;= 50 ~ \"0 to 50 miles\",\n      50 &lt; dist_to_tva & dist_to_tva &lt;= 100 ~ \"50 to 100 miles\",\n      100 &lt; dist_to_tva & dist_to_tva &lt;= 150 ~ \"100 to 150 miles\",\n      150 &lt; dist_to_tva & dist_to_tva &lt;= 200 ~ \"150 to 200 miles\",\n    )\n  ) |&gt;\n  filter(!is.na(spill)) |&gt;\n  group_by(spill) |&gt;\n  summarize()\n\nrings$spill &lt;- factor(rings$spill, levels = c(\"0 to 50 miles\", \"50 to 100 miles\", \"100 to 150 miles\", \"150 to 200 miles\"))\nnord_palette &lt;- c(\"#295080\", \"#BF616A\", \"#A3BE8C\", \"#D08770\")\ngrey_palette &lt;- c(\"grey30\", \"grey50\", \"grey70\")\n\n(spillover_map &lt;- ggplot() +\n  geom_sf(\n    data = counties |&gt; filter(fips %in% fips_in_sample),\n    fill = NA, color = \"grey40\", size = 0.5\n  ) +\n  geom_sf(data = rings, aes(fill = spill), color = NA) +\n  # Outline of TVA\n  geom_sf(data = tva, color = \"Black\", fill = NA, size = 1.1) +\n  coord_sf(datum = NA) +\n  scale_fill_manual(values = nord_palette, na.translate = FALSE) +\n  theme_kyle(base_size = 14) +\n  kfbmisc::theme_map() +\n  theme(\n    legend.position = \"inside\",\n    legend.position.inside = c(0.1, 0.15)\n  ) +\n  labs(fill = \"Spillover Bin\"))\n\n\n\n\n\n\n\nkfbmisc::tikzsave(\n  \"figures/tva/tva-sample.pdf\",\n  spillover_map,\n  width = 8, height = 4.5\n)\nkfbmisc::tikzsave(\n  \"figures/tva/tva-sample_slides.pdf\",\n  spillover_map,\n  width = 8, height = 8 * h_w_ratio\n)",
    "crumbs": [
      "TVA",
      "Kline and Moretti (2014)"
    ]
  },
  {
    "objectID": "TVA/analysis/index.html#regression",
    "href": "TVA/analysis/index.html#regression",
    "title": "Kline and Moretti (2014)",
    "section": "Regression",
    "text": "Regression\n\ndf_reg &lt;- df_reg |&gt;\n  mutate(\n    D_lnpop = winsorize_x((lnpop2000 - lnpop40) / 6, 0.01),\n    D_lnwage = winsorize_x((lnwage2000 - lnwage40) / 6, 0.01),\n    D_lnagr = winsorize_x((lnagr2000 - lnagr40) / 6, 0.01),\n    D_lnmanuf = winsorize_x((lnmanuf2000 - lnmanuf40) / 6, 0.01),\n    D_lnvfprod = winsorize_x((lnvfprod2000 - lnvfprod40) / 6, 0.01),\n    D_lnmedfaminc = winsorize_x((lnmedfaminc2000 - lnmedfaminc50) / 5, 0.01),\n    D_lnfaval = winsorize_x((lnfaval2000 - lnfaval40) / 6, 0.01),\n    D_lnpop_short = winsorize_x((lnpop60 - lnpop40) / 2, 0.01),\n    D_lnwage_short = winsorize_x((lnwage60 - lnwage40) / 2, 0.01),\n    D_lnagr_short = winsorize_x((lnagr60 - lnagr40) / 2, 0.01),\n    D_lnmanuf_short = winsorize_x((lnmanuf60 - lnmanuf40) / 2, 0.01),\n    D_lnvfprod_short = winsorize_x((lnvfprod60 - lnvfprod40) / 2, 0.01),\n    D_lnmedfaminc_short = winsorize_x((lnmedfaminc60 - lnmedfaminc50) / 1, 0.01),\n    D_lnfaval_short = winsorize_x((lnfaval60 - lnfaval40) / 2, 0.01)\n  )\n\n\n1940-2000\n\ndep_names &lt;- c(\n  \"Agricultural employment\" = \"D_lnagr\",\n  \"Manufacturing employment\" = \"D_lnmanuf\"\n)\ntable_tex &lt;- \"\"\n\nfor (y in dep_names) {\n  outcome_name &lt;- names(dep_names[dep_names == y])\n  cli::cli_h2(\"{outcome_name}\")\n\n  temp &lt;- df_reg |&gt;\n    # Drop NAs from data\n    drop_na(!!c(controls, y, \"tva_0_100\")) |&gt;\n    filter(keep == 1)\n\n  # Diff-in-Diff with Controls -----------------------------------------------\n  formula_controls &lt;- as.formula(paste0(y, \" ~ tva + \", paste(controls, collapse = \" + \")))\n  reg_controls &lt;- fixest::feols(formula_controls, data = temp, demeaned = TRUE)\n\n  X &lt;- reg_controls$X_demeaned\n  e &lt;- reg_controls$residuals\n  coords &lt;- as.matrix(temp[, c(\"lat\", \"long\")])\n  # 1 mi = 1.60934 km\n  dist_cutoff &lt;- 200 * 1.60934\n\n  cov_controls &lt;- conley_ses(X, e, coords, dist_cutoff)$Spatial\n\n  # Diff-in-Diff with Spillovers ---------------------------------------------\n  formula_controls_spill &lt;- as.formula(paste0(y, \" ~ tva + tva_0_50 + tva_50_100 + tva_100_150 + tva_150_200 + \", paste(controls, collapse = \" + \")))\n  reg_spill &lt;- fixest::feols(formula_controls_spill, data = temp, demeaned = TRUE)\n\n  X &lt;- reg_spill$X_demeaned\n  e &lt;- reg_spill$residuals\n  coords &lt;- as.matrix(temp[, c(\"lat\", \"long\")])\n  # 1 mi = 1.60934 km\n  dist_cutoff &lt;- 200 * 1.60934\n\n  cov_spill &lt;- conley_ses(X, e, coords, dist_cutoff)$Spatial\n\n\n  # Create row\n  row &lt;- \"\"\n  row_se &lt;- \"\"\n\n  # Outcome Variable\n  row &lt;- paste0(row, str_pad(outcome_name, 28, \"right\"), \"& \")\n  row_se &lt;- paste0(row_se, str_pad(\"\", 28, \"right\"), \"& \")\n\n\n  # Diff-in-Diff Controls TVA\n  pt &lt;- coef(reg_controls)[[\"tva\"]]\n  se &lt;- sqrt(cov_controls[[\"tva\", \"tva\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"& \")\n  row_se &lt;- paste0(row_se, se_str, \"& \")\n\n  # Spillover TVA\n  pt &lt;- coef(reg_spill)[[\"tva\"]]\n  se &lt;- sqrt(cov_spill[[\"tva\", \"tva\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"& \")\n  row_se &lt;- paste0(row_se, se_str, \"& \")\n\n  pt &lt;- coef(reg_spill)[[\"tva_0_50TRUE\"]]\n  se &lt;- cov_spill[[\"tva_0_50TRUE\", \"tva_0_50TRUE\"]]\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"& \")\n  row_se &lt;- paste0(row_se, se_str, \"& \")\n\n  pt &lt;- coef(reg_spill)[[\"tva_50_100TRUE\"]]\n  se &lt;- sqrt(cov_spill[[\"tva_50_100TRUE\", \"tva_50_100TRUE\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"& \")\n  row_se &lt;- paste0(row_se, se_str, \"& \")\n\n  pt &lt;- coef(reg_spill)[[\"tva_100_150TRUE\"]]\n  se &lt;- sqrt(cov_spill[[\"tva_100_150TRUE\", \"tva_100_150TRUE\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"& \")\n  row_se &lt;- paste0(row_se, se_str, \"& \")\n\n  pt &lt;- coef(reg_spill)[[\"tva_150_200TRUE\"]]\n  se &lt;- sqrt(cov_spill[[\"tva_150_200TRUE\", \"tva_150_200TRUE\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"\\\\\\\\\\n\")\n  if (y != dep_names[length(dep_names)]) {\n    row_se &lt;- paste0(row_se, se_str, \"\\\\\\\\\\n\")\n  } else {\n    row_se &lt;- paste0(row_se, se_str, \"\\n\")\n  }\n\n  cli::cat_line(row, row_se)\n\n  table_tex &lt;- paste(table_tex, row, row_se)\n}\n\n\n\n\n── Agricultural employment ──\n\n\n\n\n\n[1] \"No Panel dimension provided. Using just Spatial adjustment\"\n[1] \"No Panel dimension provided. Using just Spatial adjustment\"\nAgricultural employment     & $-0.0514^{***}$& $-0.0739^{***}$& $-0.0371^{***}$&    $-0.0164$   & $-0.0298^{***}$&  $-0.0157^{*}$ \\\\\n                            &   $(0.0114)$   &   $(0.0142)$   &   $(0.0002)$   &   $(0.0114)$   &   $(0.0096)$   &   $(0.0088)$   \\\\\n\n\n── Manufacturing employment ──\n\n\n[1] \"No Panel dimension provided. Using just Spatial adjustment\"\n[1] \"No Panel dimension provided. Using just Spatial adjustment\"\nManufacturing employment    & $0.0560^{***}$ &    $0.0350$    & $-0.0203^{***}$&    $-0.0245$   &  $-0.0331^{*}$ & $-0.0296^{**}$ \\\\\n                            &   $(0.0161)$   &   $(0.0218)$   &   $(0.0006)$   &   $(0.0282)$   &   $(0.0189)$   &   $(0.0142)$   \n\ncat(table_tex)\n\n Agricultural employment     & $-0.0514^{***}$& $-0.0739^{***}$& $-0.0371^{***}$&    $-0.0164$   & $-0.0298^{***}$&  $-0.0157^{*}$ \\\\\n                             &   $(0.0114)$   &   $(0.0142)$   &   $(0.0002)$   &   $(0.0114)$   &   $(0.0096)$   &   $(0.0088)$   \\\\\n Manufacturing employment    & $0.0560^{***}$ &    $0.0350$    & $-0.0203^{***}$&    $-0.0245$   &  $-0.0331^{*}$ & $-0.0296^{**}$ \\\\\n                             &   $(0.0161)$   &   $(0.0218)$   &   $(0.0006)$   &   $(0.0282)$   &   $(0.0189)$   &   $(0.0142)$   \n\ncat(table_tex, file = \"tables/tva_replication.tex\")\n\n\n\n1940-1960\n\ndep_names &lt;- c(\n  \"Agricultural employment\" = \"D_lnagr_short\",\n  \"Manufacturing employment\" = \"D_lnmanuf_short\"\n)\ntable_tex &lt;- \"\"\n\nfor (y in dep_names) {\n  outcome_name &lt;- names(dep_names[dep_names == y])\n  cli::cli_h2(\"{outcome_name}\")\n\n\n  temp &lt;- df_reg |&gt;\n    # Drop NAs from data\n    drop_na(!!c(controls, y, \"tva_0_100\")) |&gt;\n    filter(keep == 1)\n\n  # Diff-in-Diff with Controls -----------------------------------------------\n  formula_controls &lt;- as.formula(paste0(y, \" ~ tva + \", paste(controls, collapse = \" + \")))\n  reg_controls &lt;- fixest::feols(formula_controls, data = temp, demeaned = TRUE)\n\n  X &lt;- reg_controls$X_demeaned\n  e &lt;- reg_controls$residuals\n  coords &lt;- as.matrix(temp[, c(\"lat\", \"long\")])\n  # 1 mi = 1.60934 km\n  dist_cutoff &lt;- 200 * 1.60934\n  cov_controls &lt;- conley_ses(X, e, coords, dist_cutoff)$Spatial\n\n  # Diff-in-Diff with Spillovers ---------------------------------------------\n  formula_controls_spill &lt;- as.formula(paste0(y, \" ~ tva + tva_0_50 + tva_50_100 + tva_100_150 + tva_150_200 + \", paste(controls, collapse = \" + \")))\n  reg_spill &lt;- fixest::feols(formula_controls_spill, data = temp, demeaned = TRUE)\n\n  X &lt;- reg_spill$X_demeaned\n  e &lt;- reg_spill$residuals\n  coords &lt;- as.matrix(temp[, c(\"lat\", \"long\")])\n  # 1 mi = 1.60934 km\n  dist_cutoff &lt;- 200 * 1.60934\n  cov_spill &lt;- conley_ses(X, e, coords, dist_cutoff)$Spatial\n\n\n  # Create row\n  row &lt;- \"\"\n  row_se &lt;- \"\"\n\n  # Outcome Variable\n  row &lt;- paste0(row, str_pad(outcome_name, 28, \"right\"), \"& \")\n  row_se &lt;- paste0(row_se, str_pad(\"\", 28, \"right\"), \"& \")\n\n  # Diff-in-Diff Controls TVA\n  pt &lt;- coef(reg_controls)[[\"tva\"]]\n  se &lt;- sqrt(cov_controls[[\"tva\", \"tva\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"& \")\n  row_se &lt;- paste0(row_se, se_str, \"& \")\n\n  # Spillover TVA\n  pt &lt;- coef(reg_spill)[[\"tva\"]]\n  se &lt;- sqrt(cov_spill[[\"tva\", \"tva\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"& \")\n  row_se &lt;- paste0(row_se, se_str, \"& \")\n\n  pt &lt;- coef(reg_spill)[[\"tva_0_50TRUE\"]]\n  se &lt;- sqrt(cov_spill[[\"tva_0_50TRUE\", \"tva_0_50TRUE\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"& \")\n  row_se &lt;- paste0(row_se, se_str, \"& \")\n\n  pt &lt;- coef(reg_spill)[[\"tva_50_100TRUE\"]]\n  se &lt;- sqrt(cov_spill[[\"tva_50_100TRUE\", \"tva_50_100TRUE\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"& \")\n  row_se &lt;- paste0(row_se, se_str, \"& \")\n\n  pt &lt;- coef(reg_spill)[[\"tva_100_150TRUE\"]]\n  se &lt;- sqrt(cov_spill[[\"tva_100_150TRUE\", \"tva_100_150TRUE\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"& \")\n  row_se &lt;- paste0(row_se, se_str, \"& \")\n\n  pt &lt;- coef(reg_spill)[[\"tva_150_200TRUE\"]]\n  se &lt;- sqrt(cov_spill[[\"tva_150_200TRUE\", \"tva_150_200TRUE\"]])\n  pt_str &lt;- str_pad(reg_format(pt, se), 15, \"both\")\n  se_str &lt;- str_pad(paste0(\"$(\", sprintf(\"%0.4f\", se), \")$\"), 15, \"both\")\n  row &lt;- paste0(row, pt_str, \"\\\\\\\\\\n\")\n  if (y != dep_names[length(dep_names)]) {\n    row_se &lt;- paste0(row_se, se_str, \"\\\\\\\\\\n\")\n  } else {\n    row_se &lt;- paste0(row_se, se_str, \"\\n\")\n  }\n\n  cli::cat_line(row, row_se)\n\n  table_tex &lt;- paste(table_tex, row, row_se)\n}\n\n── Agricultural employment ──\n\n\n\n\n\n[1] \"No Panel dimension provided. Using just Spatial adjustment\"\n[1] \"No Panel dimension provided. Using just Spatial adjustment\"\nAgricultural employment     & $0.0940^{***}$ &  $0.0856^{*}$  &    $-0.0062$   &    $-0.0042$   &    $-0.0303$   &    $-0.0039$   \\\\\n                            &   $(0.0275)$   &   $(0.0444)$   &   $(0.0474)$   &   $(0.0448)$   &   $(0.0404)$   &   $(0.0298)$   \\\\\n\n\n── Manufacturing employment ──\n\n\n[1] \"No Panel dimension provided. Using just Spatial adjustment\"\n[1] \"No Panel dimension provided. Using just Spatial adjustment\"\nManufacturing employment    & $0.0894^{***}$ &  $0.0993^{**}$ &    $0.0228$    &    $0.0225$    &    $-0.0055$   &    $-0.0066$   \\\\\n                            &   $(0.0324)$   &   $(0.0432)$   &   $(0.0510)$   &   $(0.0561)$   &   $(0.0348)$   &   $(0.0253)$   \n\ncat(table_tex)\n\n Agricultural employment     & $0.0940^{***}$ &  $0.0856^{*}$  &    $-0.0062$   &    $-0.0042$   &    $-0.0303$   &    $-0.0039$   \\\\\n                             &   $(0.0275)$   &   $(0.0444)$   &   $(0.0474)$   &   $(0.0448)$   &   $(0.0404)$   &   $(0.0298)$   \\\\\n Manufacturing employment    & $0.0894^{***}$ &  $0.0993^{**}$ &    $0.0228$    &    $0.0225$    &    $-0.0055$   &    $-0.0066$   \\\\\n                             &   $(0.0324)$   &   $(0.0432)$   &   $(0.0510)$   &   $(0.0561)$   &   $(0.0348)$   &   $(0.0253)$   \n\ncat(table_tex, file = \"tables/tva_replication_short.tex\")",
    "crumbs": [
      "TVA",
      "Kline and Moretti (2014)"
    ]
  },
  {
    "objectID": "CHC/analysis/index.html",
    "href": "CHC/analysis/index.html",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "",
    "text": "Replication of Bailey and Goodman-Bacon (2015) with extension for event study framework including spillover effect controls.\nlibrary(tidyverse, warn.conflicts = FALSE)\nlibrary(sf)\nlibrary(kfbmisc)\nlibrary(fixest)\nlibrary(did2s, quietly = TRUE)\n\nslides &lt;- TRUE\nh_w_ratio &lt;- 9 / 16",
    "crumbs": [
      "CHC",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "CHC/analysis/index.html#data-cleaning",
    "href": "CHC/analysis/index.html#data-cleaning",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "Data Cleaning",
    "text": "Data Cleaning\n\ndf &lt;- haven::read_dta(here::here(\"data/chc/aer_data.dta\")) |&gt;\n  # Remove LA, New York, Chicago\n  filter(\n    !(stfips == 36 & cofips == 61) &\n      !(stfips == 6 & cofips == 37) &\n      !(stfips == 17 & cofips == 31)\n  ) |&gt;\n  # Create urban dummy\n  group_by(fips) |&gt;\n  mutate(\n    `_urb` = sum(`_60pcturban` * (year == 1960), na.rm = TRUE)\n  ) |&gt;\n  ungroup() |&gt;\n  # cut every 25% with indicator from 0\n  mutate(\n    Durb = Hmisc::cut2(`_urb`, cuts = c(0, 1, 24.999, 49.999, 74.999, 110))\n  ) |&gt;\n  replace_na(list(chc_year_exp = 0))\n\nctr_pop &lt;- read_sf(here::here(\"data/2010_centpop/\")) |&gt;\n  mutate(fips = as.numeric(paste0(STATEFP, COUNTYFP))) |&gt;\n  select(fips) |&gt;\n  arrange(fips) |&gt;\n  st_transform(st_crs(2163))\n\ndf &lt;- df |&gt;\n  filter(fips != 12025) |&gt;\n  left_join(ctr_pop, by = \"fips\") |&gt;\n  st_as_sf()",
    "crumbs": [
      "CHC",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "CHC/analysis/index.html#create-spillover-variables",
    "href": "CHC/analysis/index.html#create-spillover-variables",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "Create Spillover variables",
    "text": "Create Spillover variables\n\n## helper function: for each year, calculate within\nwithin_x_treat &lt;- function(dist, year, chc_year_exp, geometry) {\n  y &lt;- min(year)\n\n  # Last term is because Bailey and Goodman-Bacon define it for chc's before 1974\n  treated &lt;- (chc_year_exp &lt;= y) & (chc_year_exp &gt; 0) & (chc_year_exp &lt;= 1974)\n\n\n  dist_mat &lt;- st_distance(geometry, geometry) |&gt;\n    units::set_units(\"mi\") |&gt;\n    units::drop_units()\n\n  within &lt;- (dist_mat &gt; 0) & (dist_mat &lt; dist)\n\n  return(as.numeric((within %*% treated) &gt; 0))\n}\n\n\n## helper function: find minimum year that within == 1, requires sorted!\nmin_year &lt;- function(year, within) {\n  if (any(within == 1)) {\n    idx &lt;- which(within == 1)[1]\n    y &lt;- year[idx]\n  } else {\n    y &lt;- 0\n  }\n\n  return(y)\n}\n\n\ndf_spill &lt;- df |&gt;\n  group_by(year) |&gt;\n  filter(year &lt;= 1988) |&gt;\n  # Create within indicator\n  mutate(\n    # CHC is included if added up to 1974\n    # Definition from Bailey and Goodman-Bacon\n    chc_open = if_else(chc_year_exp &lt;= 1974, chc_year_exp, 0),\n    # Create D_it\n    treat = as.numeric((chc_year_exp &lt;= year) & (chc_year_exp != 0)),\n    # Create S_it\n    within_25 = within_x_treat(25, year, chc_year_exp, geometry),\n    # S_it (1 - D_it)\n    within_25 = within_25 * (1 - treat)\n  ) |&gt;\n  ungroup() |&gt;\n  # Arrange panel by fips year\n  arrange(fips, year) |&gt;\n  group_by(fips) |&gt;\n  mutate(\n    # Create D_it^k's\n    rel_year = case_when(\n      chc_year_exp == 0 ~ -1,\n      chc_year_exp &gt;= 1975 ~ -1,\n      TRUE ~ year - chc_year_exp\n    ),\n    # Minimum year where S_it = 1\n    year_within_25 = min_year(year, within_25),\n    # Create S_it^k\n    spill_rel_year = case_when(\n      year_within_25 == 0 ~ -Inf,\n      treat == 1 ~ -Inf,\n      TRUE ~ year - year_within_25\n    ),\n    # max(D_it, S_it)\n    treat_or_spill = treat + within_25,\n    # Create trend variables for controls\n    Durb_trend = as.factor(paste(year, Durb, sep = \"_\")),\n    Durb_trend = as.factor(as.numeric(Durb_trend)),\n    stfips_trend = as.factor(paste(year, stfips, sep = \"_\")),\n    stfips_trend = as.factor(as.numeric(stfips_trend)),\n  ) |&gt;\n  ungroup()",
    "crumbs": [
      "CHC",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "CHC/analysis/index.html#replicate-event-study",
    "href": "CHC/analysis/index.html#replicate-event-study",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "Replicate Event Study",
    "text": "Replicate Event Study\n\nes_pts &lt;- df |&gt;\n  filter(year &lt;= 1988) |&gt;\n  st_drop_geometry() |&gt;\n  fixest::feols(\n    amr ~ i(exp1, ref = -1) + D_tot_act_md_t + D_60pctnonwhit_t + D_60pctrurf_t + D_60pcturban_t + D_pct59inclt3k_t + R_tranpcret + R_tranpcpa1 + H_bpc + H_hpc | fips + year + year^Durb + year^stfips,\n    weights = ~popwt\n  ) |&gt;\n  broom::tidy() |&gt;\n  filter(stringr::str_detect(term, \"exp1::\")) |&gt;\n  mutate(\n    time = as.numeric(stringr::str_remove(term, \"exp1::\"))\n  ) |&gt;\n  select(time, estimate, std.error) |&gt;\n  add_row(tibble(time = -1, estimate = 0, std.error = 0)) |&gt;\n  mutate(\n    ub = estimate + 1.96 * std.error,\n    lb = estimate - 1.96 * std.error\n  ) |&gt;\n  filter(time &lt;= 14)\n\nNOTE: 540 observations removed because of NA values (LHS: 90, RHS: 540, Weights: 90).",
    "crumbs": [
      "CHC",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "CHC/analysis/index.html#modern-event-study",
    "href": "CHC/analysis/index.html#modern-event-study",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "Modern Event Study",
    "text": "Modern Event Study\n\n# No spillover control, but modern estimator\nes_1 &lt;- df_spill |&gt;\n  sf::st_drop_geometry() |&gt;\n  drop_na(D_tot_act_md_t, D_60pctnonwhit_t, D_60pctrurf_t, D_60pcturban_t, D_pct59inclt3k_t, R_tranpcret, R_tranpcpa1, H_bpc, H_hpc, Durb_trend) |&gt;\n  did2s::did2s(\n    yname = \"amr\",\n    first_stage = ~ D_tot_act_md_t + D_60pctnonwhit_t + D_60pctrurf_t + D_60pcturban_t + D_pct59inclt3k_t + R_tranpcret + R_tranpcpa1 + H_bpc + H_hpc | fips + year + Durb_trend + stfips_trend,\n    second_stage = ~ i(rel_year, ref = -1),\n    treatment = \"treat\",\n    weights = \"popwt\",\n    cluster_var = \"stfips\"\n  )\n\nRunning Two-stage Difference-in-Differences\n - first stage formula `~ D_tot_act_md_t + D_60pctnonwhit_t + D_60pctrurf_t + D_60pcturban_t + D_pct59inclt3k_t + R_tranpcret + R_tranpcpa1 + H_bpc + H_hpc | fips + year + Durb_trend + stfips_trend`\n - second stage formula `~ i(rel_year, ref = -1)`\n - The indicator variable that denotes when treatment is on is `treat`\n - Standard errors will be clustered by `stfips`\n\n\nNOTE: The fixed-effects are not regular, they cannot be straightforwardly interpreted.\n\n# Preview es result\niplot(es_1)\n\n\n\n\n\n\n\n\n\n# Spillover controls\nes_2 &lt;- did2s::did2s(\n  data = df_spill |&gt;\n    sf::st_drop_geometry() |&gt;\n    # Filter out NAs\n    drop_na(D_tot_act_md_t, D_60pctnonwhit_t, D_60pctrurf_t, D_60pcturban_t, D_pct59inclt3k_t, R_tranpcret, R_tranpcpa1, H_bpc, H_hpc, Durb_trend, stfips_trend),\n  yname = \"amr\",\n  first_stage = ~ D_tot_act_md_t + D_60pctnonwhit_t + D_60pctrurf_t + D_60pcturban_t + D_pct59inclt3k_t + R_tranpcret + R_tranpcpa1 + H_bpc + H_hpc | fips + year + Durb_trend + stfips_trend,\n  second_stage = ~ i(rel_year) + i(spill_rel_year, ref = -Inf),\n  treatment = \"treat_or_spill\",\n  weights = \"popwt\",\n  cluster_var = \"stfips\"\n)\n\nRunning Two-stage Difference-in-Differences\n - first stage formula `~ D_tot_act_md_t + D_60pctnonwhit_t + D_60pctrurf_t + D_60pcturban_t + D_pct59inclt3k_t + R_tranpcret + R_tranpcpa1 + H_bpc + H_hpc | fips + year + Durb_trend + stfips_trend`\n - second stage formula `~ i(rel_year) + i(spill_rel_year, ref = -Inf)`\n - The indicator variable that denotes when treatment is on is `treat_or_spill`\n - Standard errors will be clustered by `stfips`\n\n\nNOTE: The fixed-effects are not regular, they cannot be straightforwardly interpreted.\n\niplot(es_2)\n\n\n\n\n\n\n\n\n\nes_pts_combined &lt;- broom::tidy(es_2) |&gt;\n  mutate(\n    # Split term to variable and relative time\n    term_split = str_split(term, \"::\"),\n    term = unlist(lapply(term_split, \\(x) x[1])),\n    time = unlist(lapply(term_split, \\(x) x[2])),\n    time = as.numeric(time),\n    # Confidence interval\n    ub = estimate + 1.96 * std.error,\n    lb = estimate - 1.96 * std.error,\n    # Term for plotting\n    group = case_when(\n      term == \"rel_year\" ~ \"Treatment Effect\",\n      term == \"spill_rel_year\" ~ \"Spillover On Control\",\n    )\n  ) |&gt;\n  # Filter years to match original\n  filter(time &lt;= 14 & time &gt;= -7) |&gt;\n  # Shift for plotting\n  mutate(time = if_else(term == \"rel_year\", time + 0.2, time - 0.2))\n\n# Add -1 for plotting\nes_pts_combined &lt;- bind_rows(\n  es_pts_combined,\n  tibble(time = c(-1.2, -0.8), estimate = c(0, 0), ub = c(0, 0), lb = c(0, 0), group = c(\"Spillover On Control\", \"Treatment Effect\"))\n)",
    "crumbs": [
      "CHC",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "CHC/analysis/index.html#export-figures",
    "href": "CHC/analysis/index.html#export-figures",
    "title": "Bailey and Goodman-Bacon (2015)",
    "section": "Export figures",
    "text": "Export figures\n\n# treatment effect original\n(es_plot_original &lt;- ggplot(es_pts) +\n  geom_vline(xintercept = -0.5, color = \"grey50\") +\n  geom_hline(yintercept = 0, color = \"black\") +\n  geom_point(aes(x = time, y = estimate), color = \"#bf616a\") +\n  geom_errorbar(aes(x = time, ymin = lb, ymax = ub), color = \"#bf616a\", alpha = 0.8) +\n  theme_kyle(base_size = 12) +\n  theme(title = element_text(size = 12, margin = margin(b = 0, unit = \"pt\"))) +\n  scale_x_continuous(minor_breaks = seq(-7, 14, 1)) +\n  scale_y_continuous(minor_breaks = seq(-75, 50, 5), limits = c(-75, 50)) +\n  labs(y = \"Deaths per 100,000 persons\", x = \"Years since CHC establishment\", color = NULL))\n\n\n\n\n\n\n\nkfbmisc::tikzsave(\n  here::here(\"figures/chc/chc-es_original_slides.pdf\"), \n  es_plot_original, width = 8, height = 8 * h_w_ratio\n)\nkfbmisc::tikzsave(\n  here::here(\"figures/chc/chc-es_original.pdf\"), \n  es_plot_original, width = 8, height = 5\n)\n\n\n(es_plot_combined &lt;- ggplot(es_pts_combined) +\n  geom_vline(xintercept = -0.5, color = \"grey50\") +\n  geom_hline(yintercept = 0, color = \"black\") +\n  geom_point(aes(x = time, y = estimate, color = group)) +\n  geom_errorbar(aes(x = time, ymin = lb, ymax = ub, color = group), alpha = 0.8) +\n  kfbmisc::theme_kyle(base_size = 12) +\n  theme(\n    legend.position = \"inside\",\n    legend.position.inside = c(0.165, 0.25),\n    legend.spacing.x = unit(0, \"pt\"),\n    legend.spacing.y = unit(0, \"pt\"),\n    legend.background = element_rect(fill = \"white\"),\n    panel.grid.minor.y = element_blank()\n  ) +\n  scale_shape_manual(values = c(16, 18)) +\n  scale_color_manual(values = c(\"#5e81ac\", \"#bf616a\")) +\n  scale_x_continuous(minor_breaks = seq(-7, 14, 1)) +\n  scale_y_continuous(minor_breaks = seq(-75, 45, 50), limits = c(-75, 50)) +\n  labs(y = \"Deaths per 100,000 persons\", x = \"Years since CHC establishment\", color = NULL))\n\n\n\n\n\n\n\n\n\nkfbmisc::tikzsave(\n  here::here(\"figures/chc/chc-es_combined_slides.pdf\"),\n  es_plot_combined,\n  width = 8, height = 8 * h_w_ratio\n)\nkfbmisc::tikzsave(\n  here::here(\"figures/chc/chc-es_combined.pdf\"),\n  es_plot_combined,\n  width = 8, height = 5\n)",
    "crumbs": [
      "CHC",
      "Bailey and Goodman-Bacon (2015)"
    ]
  },
  {
    "objectID": "simulations/misspecified_exposure_mapping/index.html",
    "href": "simulations/misspecified_exposure_mapping/index.html",
    "title": "Misspecification of Exposure Mapping",
    "section": "",
    "text": "This file performs a set of Monte Carlo simulations that estimate a set of DGPs using various exposure mappings and estimates them using exposure mappings and ring(s). The first simulation reports on average bias found in the treatment effect estimate and the second simulation reports on the ability to accurately predict spillover effects from fitted values.\nlibrary(tidyverse, warn.conflicts = FALSE)\nlibrary(data.table)\nlibrary(here)\nlibrary(glue)\nlibrary(sf)\nlibrary(stars)\nlibrary(fixest)\nlibrary(doParallel)\nlibrary(gt)\nlibrary(kfbmisc)\nlibrary(Matrix)\n\n# flags\nEXPORT &lt;- FALSE\nRUN &lt;- TRUE\n# extract_body()\nextract_body &lt;- function(gt) {\n  if (inherits(gt, \"gt_tbl\")) gt &lt;- as.character(gt::as_latex(gt))\n    gt = stringr::str_split_1(gt, \"\\\\n\")\n    \n    idx = c(\n        which(str_detect(gt, \"\\\\\\\\midrule\")) + 1,\n        which(str_detect(gt, \"\\\\\\\\bottomrule\")) - 1\n    )\n    gt = paste0(gt[idx[1]:idx[2]], collapse = \"\\n\")\n  stringr::str_remove(gt, \" \\\\\\\\\\\\\\\\ \\n$\")\n}\n\n# sim_data_misspecification()\nsource(here::here(\"code/simulations/helper-sim_function_misspecification.R\"))\n\n# Helper function estimate\nestimate_treatment_effect &lt;- function(df, formula, treat_var) {\n  coef(feols(formula, data = df, warn = FALSE, notes = FALSE))[[treat_var]]\n}\nFrom data_prepare_counties.R\n# counties, dist_mi\nload(file = here::here(\"data/counties_and_mat.RData\"))\n\ncounties = counties |&gt; st_drop_geometry() |&gt; as.data.table()\n\n# Logical matrix, =1 if within the maxmium distance for spillover\nwithin &lt;- (dist_mi &gt; 0 & dist_mi &lt;= 40)\nwithin_large &lt;- (dist_mi &gt; 0 & dist_mi &lt;= 80)\nwithin_100 &lt;- (dist_mi &gt; 0 & dist_mi &lt;= 100)\nwithin_0_20 &lt;- (dist_mi &gt; 0 & dist_mi &lt;= 20)\nwithin_20_30 &lt;- (dist_mi &gt; 20 & dist_mi &lt;= 30)\nwithin_30_40 &lt;- (dist_mi &gt; 30 & dist_mi &lt;= 40)\nwithin_40_60 &lt;- (dist_mi &gt; 40 & dist_mi &lt;= 60)\nwithin_60_80 &lt;- (dist_mi &gt; 60 & dist_mi &lt;= 80)\nwithin_80_100 &lt;- (dist_mi &gt; 60 & dist_mi &lt;= 80)\n\n# Spatial Decay\n# Cutoff by element-wise multiplication & no self-spillover\n# Following https://fmwww.bc.edu/repec/bocode/s/spgen.pdf\nspatial_decay &lt;- exp(-.02 * dist_mi)\nspatial_decay &lt;- spatial_decay * within_large\n\n# Convert to sparse matrices\nwithin &lt;- as(within, \"dgCMatrix\")\nwithin_large &lt;- as(within_large, \"dgCMatrix\")\nwithin_100 &lt;- as(within_100, \"dgCMatrix\")\nwithin_0_20 &lt;- as(within_0_20, \"dgCMatrix\")\nwithin_20_30 &lt;- as(within_20_30, \"dgCMatrix\")\nwithin_30_40 &lt;- as(within_30_40, \"dgCMatrix\")\nwithin_40_60 &lt;- as(within_40_60, \"dgCMatrix\")\nwithin_60_80 &lt;- as(within_60_80, \"dgCMatrix\")\nwithin_80_100 &lt;- as(within_80_100, \"dgCMatrix\")\nspatial_decay &lt;- as(spatial_decay, \"dgCMatrix\")",
    "crumbs": [
      "Simulations",
      "Misspecification of Exposure Mapping"
    ]
  },
  {
    "objectID": "simulations/misspecified_exposure_mapping/index.html#simulation-bias",
    "href": "simulations/misspecified_exposure_mapping/index.html#simulation-bias",
    "title": "Misspecification of Exposure Mapping",
    "section": "Simulation: Bias",
    "text": "Simulation: Bias\nSimulates a set of DGPs with different kinds of exposure mappings For each DGP, estimates using many different parametric forms + ring(s) method Report on the bias of the treatment effect estimate\n\nn_trials &lt;- 100\ndoParallel::registerDoParallel(10)\n\ndgp_types &lt;- c(\n  \"Within 40mi.\" = \"spill_within\",\n  \"Within 80mi.\" = \"spill_within_large\",\n  \"Decay\" = \"spill_decay\",\n  \"Within 40mi. (Additive)\" = \"spill_within_additive\",\n  \"Within 80mi. (Additive)\" = \"spill_within_large_additive\",\n  \"Decay (Additive)\" = \"spill_decay_additive\"\n)\n\nestimation_types &lt;- c(\n  \"TWFE (No Spillovers)\" = \"twfe\",\n  \"Within 40mi.\" = \"spill_within\",\n  \"Within 80mi.\" = \"spill_within_large\",\n  \"Within 40mi. (Additive)\" = \"spill_within_additive\",\n  \"Within 80mi. (Additive)\" = \"spill_within_large_additive\",\n  \"Decay\" = \"spill_decay\",\n  \"Decay (Additive)\" = \"spill_decay_additive\",\n  \"Rings (0-20, 20-30, 30-40)\" = \"donuts_small\",\n  \"Rings (0-20, 20-30, 30-40, 40-60, 60-80)\" = \"donuts\",\n  \"Rings (0-20, 20-30, 30-40, 40-60, 60-80) (Additive)\" = \"donuts_additive\"\n)\n\nif (RUN) {\n  results &lt;- foreach(i = 1:n_trials, .combine = \"rbind\") %dopar% {\n    df &lt;- sim_data_misspecification(counties)\n    results_trial &lt;- NULL\n\n    for (y in dgp_types) {\n      for (x in estimation_types) {\n        if (x == \"twfe\") {\n          formula &lt;- as.formula(glue(\"y_{y} ~ treat_ind | state_county + year\"))\n        } else if (x == \"donuts_small\") {\n          formula &lt;- as.formula(glue(\"y_{y} ~ treat_ind + spill_0_20:post + spill_20_30:post + spill_30_40:post | state_county + year\"))\n        } else if (x == \"donuts\") {\n          formula &lt;- as.formula(glue(\n            \"y_{y} ~ treat_ind + spill_0_20:post + spill_20_30:post + spill_30_40:post \",\n            \"+ spill_40_60:post + spill_60_80:post | state_county + year\"\n          ))\n        } else if (x == \"donuts_additive\") {\n          formula &lt;- as.formula(glue(\n            \"y_{y} ~ treat_ind + spill_0_20_additive:post + spill_20_30_additive:post + spill_30_40_additive:post \",\n            \"+ spill_40_60_additive:post + spill_60_80_additive:post | state_county + year\"\n          ))\n        } else {\n          formula &lt;- as.formula(glue(\"y_{y} ~ treat_ind + ({x}:post) | state_county + year\"))\n        }\n\n        treat_var &lt;- as.character(glue(\"treat_ind\"))\n\n        te_hat &lt;- estimate_treatment_effect(df, formula, treat_var)\n\n        dgp &lt;- names(dgp_types)[dgp_types == y]\n        spec &lt;- names(estimation_types)[estimation_types == x]\n\n        results_trial &lt;- bind_rows(results_trial, tibble(\n          dgp = dgp, spec = spec, te_hat = te_hat\n        ))\n      }\n    }\n\n    return(results_trial)\n  }\n}\n\n## Save results\nif (RUN) save(results, file = \"data/sim_misspecification.RData\")\n\n## Load results if not running simulation\nif (!RUN) load(\"data/sim_misspecification.RData\")\n\nresults_tbl &lt;- results |&gt;\n  mutate(\n    bias = 2 - te_hat\n  ) |&gt;\n  summarize(\n    # ci_lower = quantile(bias, probs = 0.05),\n    # ci_upper = quantile(bias, probs = 0.95),\n    mse = sum(bias^2) / n(),\n    bias = mean(bias), \n        .by = c(spec, dgp)\n  ) |&gt;\n  select(spec, dgp, bias, mse)\n\n\n# Format into tex table\ntable_tex &lt;- \"\"\n\nfor (spec in estimation_types) {\n  # Create row\n  row &lt;- \"\"\n  row_se &lt;- \"\"\n\n  # Specification Name\n  spec_name &lt;- names(estimation_types)[estimation_types == spec]\n  row &lt;- paste0(row, str_pad(spec_name, 55, \"right\"))\n  row_se &lt;- paste0(row_se, str_pad(\"\", 55, \"right\"))\n\n  for (dgp in dgp_types) {\n    row &lt;- paste0(row, \"& \")\n    row_se &lt;- paste0(row_se, \"& \")\n\n    # DGP Names\n    dgp_name &lt;- names(dgp_types)[dgp_types == dgp]\n    temp &lt;- results_tbl |&gt; filter(spec == spec_name & dgp == dgp_name)\n\n    bias &lt;- round(temp$bias, digits = 3) |&gt;\n      format(digits = 3, nsmall = 3) |&gt;\n      str_pad(8, side = \"right\")\n    mse &lt;- \n            paste0(\"[\", format(round(temp$mse, digits = 3), nsmall = 3), \"]\") |&gt; \n            str_pad(8, side = \"right\")\n\n    row &lt;- paste0(row, bias)\n    row_se &lt;- paste0(row_se, mse)\n  }\n\n  row &lt;- paste0(row, \"\\\\\\\\\")\n  if (spec != estimation_types[length(estimation_types)]) {\n    row_se &lt;- paste0(row_se, \"\\\\\\\\\")\n  }\n  # cli::cat_line(row, \"\\n\", row_se, \"\\n\")\n\n  table_tex &lt;- paste(table_tex, row, row_se, sep = \"\\n\")\n}\n\ncli::cli_h1(\"Misspecification Bias Results\")\n\n\n\n\n── Misspecification Bias Results ───────────────────────────────────────────────\n\ncat(table_tex)\n\n\nTWFE (No Spillovers)                                   & 0.237   & 0.237   & -0.547  & 0.237   & 0.237   & 0.237   \\\\\n                                                       & [0.076] & [0.076] & [0.321] & [0.076] & [0.076] & [0.076] \\\\\nWithin 40mi.                                           & -0.021  & 0.198   & -0.626  & -0.021  & 0.163   & 0.129   \\\\\n                                                       & [0.020] & [0.059] & [0.414] & [0.020] & [0.046] & [0.037] \\\\\nWithin 80mi.                                           & -0.029  & -0.029  & -0.775  & -0.029  & -0.029  & -0.029  \\\\\n                                                       & [0.022] & [0.022] & [0.622] & [0.022] & [0.022] & [0.022] \\\\\nWithin 40mi. (Additive)                                & 0.026   & 0.206   & -0.614  & -0.022  & 0.164   & 0.129   \\\\\n                                                       & [0.020] & [0.062] & [0.399] & [0.020] & [0.047] & [0.037] \\\\\nWithin 80mi. (Additive)                                & 0.015   & 0.113   & -0.683  & -0.030  & -0.028  & -0.029  \\\\\n                                                       & [0.021] & [0.034] & [0.490] & [0.022] & [0.022] & [0.022] \\\\\nDecay                                                  & 1.196   & 0.659   & -0.032  & 1.231   & 0.782   & 0.894   \\\\\n                                                       & [1.468] & [0.468] & [0.034] & [1.553] & [0.647] & [0.835] \\\\\nDecay (Additive)                                       & -0.044  & 0.129   & -0.691  & -0.104  & 0.003   & -0.025  \\\\\n                                                       & [0.023] & [0.038] & [0.500] & [0.032] & [0.021] & [0.021] \\\\\nRings (0-20, 20-30, 30-40)                             & -0.021  & 0.198   & -0.626  & -0.021  & 0.163   & 0.129   \\\\\n                                                       & [0.020] & [0.059] & [0.414] & [0.020] & [0.046] & [0.037] \\\\\nRings (0-20, 20-30, 30-40, 40-60, 60-80)               & -0.029  & -0.029  & -0.775  & -0.029  & -0.029  & -0.029  \\\\\n                                                       & [0.022] & [0.022] & [0.622] & [0.022] & [0.022] & [0.022] \\\\\nRings (0-20, 20-30, 30-40, 40-60, 60-80) (Additive)    & 0.016   & 0.113   & -0.682  & -0.027  & -0.027  & -0.028  \\\\\n                                                       & [0.021] & [0.034] & [0.489] & [0.022] & [0.022] & [0.022] \n\nif (EXPORT) cat(table_tex, file = \"tables/misspecification.tex\")",
    "crumbs": [
      "Simulations",
      "Misspecification of Exposure Mapping"
    ]
  },
  {
    "objectID": "simulations/misspecified_exposure_mapping/index.html#simulation-mspe-of-spillovers",
    "href": "simulations/misspecified_exposure_mapping/index.html#simulation-mspe-of-spillovers",
    "title": "Misspecification of Exposure Mapping",
    "section": "Simulation: MSPE of Spillovers",
    "text": "Simulation: MSPE of Spillovers\nSimulates a set of DGPs with different kinds of exposure mappings For each DGP, estimates using many different parametric forms + ring(s) method Estimate spillover effect for control units and determine mspe of spillover\n\nn_trials &lt;- 1000\ndoParallel::registerDoParallel(10)\n\ndgp_types &lt;- c(\n  \"Within 40mi.\" = \"spill_within\",\n  \"Within 80mi.\" = \"spill_within_large\",\n  \"Decay\" = \"spill_decay\",\n  \"Within 40mi. (Additive)\" = \"spill_within_additive\",\n  \"Within 80mi. (Additive)\" = \"spill_within_large_additive\",\n  \"Decay (Additive)\" = \"spill_decay_additive\"\n)\n\nestimation_types &lt;- c(\n  \"TWFE (No Spillovers)\" = \"twfe\",\n  \"Within 40mi.\" = \"spill_within\",\n  \"Within 80mi.\" = \"spill_within_large\",\n  \"Within 40mi. (Additive)\" = \"spill_within_additive\",\n  \"Within 80mi. (Additive)\" = \"spill_within_large_additive\",\n  \"Decay\" = \"spill_decay\",\n  \"Decay (Additive)\" = \"spill_decay_additive\",\n  \"Rings (0-20, 20-30, 30-40)\" = \"donuts_small\",\n  \"Rings (0-20, 20-30, 30-40, 40-60, 60-80)\" = \"donuts\",\n  \"Rings (0-20, 20-30, 30-40, 40-60, 60-80) (Additive)\" = \"donuts_additive\"\n)\n\nif (RUN) {\n  results_mspe &lt;- foreach(i = 1:n_trials, .combine = \"rbind\") %dopar% {\n    df &lt;- sim_data_misspecification(counties)\n    results_trial &lt;- NULL\n\n    for (y in dgp_types) {\n      for (x in estimation_types) {\n        if (x == \"twfe\") {\n          df &lt;- df |&gt;\n            mutate(te_spill_hat = 0)\n        } else if (x == \"donuts_small\") {\n          formula &lt;- as.formula(glue(\"y_{y} ~ treat_ind + post:spill_0_20 + spill_20_30:post + spill_30_40:post | state_county + year\"))\n\n          reg &lt;- feols(formula, data = df, warn = FALSE, notes = FALSE)\n\n          coef &lt;- reg |&gt; coefficients()\n          b_0_20 &lt;- coef[2]\n          b_20_30 &lt;- coef[3]\n          b_30_40 &lt;- coef[4]\n\n          df &lt;- df |&gt;\n            mutate(\n              te_spill_hat = b_0_20 * spill_0_20 + b_20_30 * spill_20_30 + b_30_40 * spill_30_40\n            )\n        } else if (x == \"donuts\") {\n          formula &lt;- as.formula(glue(\n            \"y_{y} ~ treat_ind + post:spill_0_20 + spill_20_30:post + spill_30_40:post \",\n            \"+ spill_40_60:post + spill_60_80:post | state_county + year\"\n          ))\n\n          reg &lt;- feols(formula, data = df, warn = FALSE, notes = FALSE)\n\n          coef &lt;- reg |&gt; coefficients()\n          b_0_20 &lt;- coef[2]\n          b_20_30 &lt;- coef[3]\n          b_30_40 &lt;- coef[4]\n          b_40_60 &lt;- coef[5]\n          b_60_80 &lt;- coef[6]\n\n          df &lt;- df |&gt;\n            mutate(\n              te_spill_hat = b_0_20 * spill_0_20 + b_20_30 * spill_20_30 + b_30_40 * spill_30_40 + b_40_60 * spill_40_60 + b_60_80 * spill_60_80\n            )\n        } else if (x == \"donuts_additive\") {\n          formula &lt;- as.formula(glue(\n            \"y_{y} ~ treat_ind + post:spill_0_20_additive + spill_20_30_additive:post + spill_30_40_additive:post \",\n            \"+ spill_40_60_additive:post + spill_60_80_additive:post | state_county + year\"\n          ))\n\n          reg &lt;- feols(formula, data = df, warn = FALSE, notes = FALSE)\n\n          coef &lt;- reg |&gt; coefficients()\n          b_0_20 &lt;- coef[2]\n          b_20_30 &lt;- coef[3]\n          b_30_40 &lt;- coef[4]\n          b_40_60 &lt;- coef[5]\n          b_60_80 &lt;- coef[6]\n\n          df &lt;- df |&gt;\n            mutate(\n              te_spill_hat = b_0_20 * spill_0_20_additive + b_20_30 * spill_20_30_additive + b_30_40 * spill_30_40_additive + b_40_60 * spill_40_60_additive + b_60_80 * spill_60_80_additive\n            )\n        } else {\n          formula &lt;- as.formula(glue(\"y_{y} ~ treat_ind + ({x}:post) | state_county + year\"))\n\n          reg &lt;- feols(formula, data = df, warn = FALSE, notes = FALSE)\n          coef &lt;- reg |&gt; coefficients()\n          b &lt;- coef[2]\n\n          df &lt;- df |&gt;\n            mutate(\n              te_spill_hat = b * !!rlang::sym(x)\n            )\n        }\n\n        # Calculate MSPE and normalize\n\n        true_spill &lt;- df |&gt;\n          filter(year == 2019 & treat == 0) |&gt;\n          pull(glue(\"te_{y}\"))\n        estimated_spill &lt;- df |&gt;\n          filter(year == 2019 & treat == 0) |&gt;\n          pull(\"te_spill_hat\")\n\n        mspe &lt;- sum((true_spill - estimated_spill)^2)\n        total_var &lt;- sum((true_spill^2))\n\n        normalized_mspe &lt;- mspe / total_var\n\n        dgp &lt;- names(dgp_types)[dgp_types == y]\n        spec &lt;- names(estimation_types)[estimation_types == x]\n\n        results_trial &lt;- bind_rows(results_trial, tibble(\n          dgp = dgp, spec = spec, normalized_mspe = normalized_mspe\n        ))\n      }\n    }\n\n    return(results_trial)\n  }\n}\n\nif (RUN) save(results_mspe, file = here::here(\"data/sim_misspecification_mspe.RData\"))\nif (!RUN) load(here::here(\"data/sim_misspecification_mspe.RData\"))\n\n\nresults_tbl &lt;- results_mspe |&gt;\n  summarize(\n    # Makes 1 the best, 0 the worst\n    percent_explained = 1 - mean(normalized_mspe),\n        .by = c(spec, dgp)\n  ) |&gt;\n  select(spec, dgp, percent_explained) |&gt;\n  pivot_wider(names_from = dgp, values_from = percent_explained) |&gt;\n  # Order columns\n  select(spec, names(dgp_types)) |&gt;\n  # Order rows\n  arrange(match(spec, names(estimation_types)))\n\n\ntab_mspe = results_tbl |&gt;\n  gt::gt() |&gt;\n  gt::fmt_number(\n    columns = 2:7,\n    decimals = 3\n  ) |&gt;\n  extract_body()\n    \ncat(tab_mspe)\n\nTWFE (No Spillovers) & $0.000$ & $0.000$ & $0.000$ & $0.000$ & $0.000$ & $0.000$ \\\\ \nWithin 40mi. & $0.993$ & $0.254$ & $0.586$ & $0.854$ & $0.386$ & $0.558$ \\\\ \nWithin 80mi. & $0.394$ & $0.963$ & $0.843$ & $0.339$ & $0.715$ & $0.676$ \\\\ \nWithin 40mi. (Additive) & $0.851$ & $0.208$ & $0.512$ & $0.995$ & $0.406$ & $0.607$ \\\\ \nWithin 80mi. (Additive) & $0.456$ & $0.616$ & $0.702$ & $0.471$ & $0.983$ & $0.934$ \\\\ \nDecay & $0.599$ & $0.821$ & $0.963$ & $0.524$ & $0.755$ & $0.818$ \\\\ \nDecay (Additive) & $0.604$ & $0.563$ & $0.777$ & $0.636$ & $0.932$ & $0.984$ \\\\ \nRings (0-20, 20-30, 30-40) & $0.223$ & $0.070$ & $-0.081$ & $-0.039$ & $0.048$ & $-0.054$ \\\\ \nRings (0-20, 20-30, 30-40, 40-60, 60-80) & $0.144$ & $0.545$ & $0.019$ & $-0.094$ & $0.228$ & $-0.005$ \\\\ \nRings (0-20, 20-30, 30-40, 40-60, 60-80) (Additive) & $0.834$ & $0.574$ & $0.712$ & $0.976$ & $0.950$ & $0.950$ \\\\ \n\ncat(\"\\n\\n\")\nif (EXPORT) {\n    cat(tab_mspe, file = here::here(\"tables/misspecification_mspe.tex\"))\n}\n\n\ntab_mspe_pct = results_tbl |&gt;\n  gt::gt() |&gt;\n  gt::fmt_percent(\n    columns = 2:7,\n    decimals = 1\n  ) |&gt;\n  extract_body() \n\ncat(tab_mspe_pct)\n\nTWFE (No Spillovers) & $0.0\\%$ & $0.0\\%$ & $0.0\\%$ & $0.0\\%$ & $0.0\\%$ & $0.0\\%$ \\\\ \nWithin 40mi. & $99.3\\%$ & $25.4\\%$ & $58.6\\%$ & $85.4\\%$ & $38.6\\%$ & $55.8\\%$ \\\\ \nWithin 80mi. & $39.4\\%$ & $96.3\\%$ & $84.3\\%$ & $33.9\\%$ & $71.5\\%$ & $67.6\\%$ \\\\ \nWithin 40mi. (Additive) & $85.1\\%$ & $20.8\\%$ & $51.2\\%$ & $99.5\\%$ & $40.6\\%$ & $60.7\\%$ \\\\ \nWithin 80mi. (Additive) & $45.6\\%$ & $61.6\\%$ & $70.2\\%$ & $47.1\\%$ & $98.3\\%$ & $93.4\\%$ \\\\ \nDecay & $59.9\\%$ & $82.1\\%$ & $96.3\\%$ & $52.4\\%$ & $75.5\\%$ & $81.8\\%$ \\\\ \nDecay (Additive) & $60.4\\%$ & $56.3\\%$ & $77.7\\%$ & $63.6\\%$ & $93.2\\%$ & $98.4\\%$ \\\\ \nRings (0-20, 20-30, 30-40) & $22.3\\%$ & $7.0\\%$ & $-8.1\\%$ & $-3.9\\%$ & $4.8\\%$ & $-5.4\\%$ \\\\ \nRings (0-20, 20-30, 30-40, 40-60, 60-80) & $14.4\\%$ & $54.5\\%$ & $1.9\\%$ & $-9.4\\%$ & $22.8\\%$ & $-0.5\\%$ \\\\ \nRings (0-20, 20-30, 30-40, 40-60, 60-80) (Additive) & $83.4\\%$ & $57.4\\%$ & $71.2\\%$ & $97.6\\%$ & $95.0\\%$ & $95.0\\%$ \\\\ \n\ncat(\"\\n\\n\")\nif (EXPORT) {\n    cat(tab_mspe_pct, file = here::here(\"tables/misspecification_mspe_percent.tex\"))\n}",
    "crumbs": [
      "Simulations",
      "Misspecification of Exposure Mapping"
    ]
  }
]